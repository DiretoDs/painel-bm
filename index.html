<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="referrer" content="no-referrer" />
  <meta http-equiv="Content-Security-Policy" content="frame-ancestors 'none'; base-uri 'self'" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Planejamento Parceiros ‚Äî BMs + Programa√ß√£o</title>
  <style>
    :root{
      --bg:#0b1220;
      --text:#e7eefc;
      --muted:#a9b6d3;
      --line:rgba(255,255,255,.10);
      --shadow: 0 10px 25px rgba(0,0,0,.35);
      --radius:16px;
      --radius2:12px;
      --accent:#4f9cff;
      --good:#35d07f;
      --mid:#f7c948;
      --bad:#ff5b5b;
      --chip:#1a2a49;
      --focus:0 0 0 3px rgba(79,156,255,.25);
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--sans);
      background:
        radial-gradient(1200px 800px at 12% 8%, rgba(79,156,255,.25), transparent 60%),
        radial-gradient(1100px 800px at 92% 12%, rgba(168,85,247,.18), transparent 60%),
        radial-gradient(1000px 800px at 10% 92%, rgba(53,208,127,.16), transparent 60%),
        radial-gradient(1000px 800px at 90% 92%, rgba(247,201,72,.14), transparent 60%),
        linear-gradient(180deg, rgba(255,255,255,.035), rgba(255,255,255,0) 58%),
        var(--bg);
      background-attachment: fixed;
      color:var(--text);
    }
    body::before{
      content:"";
      position:fixed;
      inset:0;
      pointer-events:none;
      background:
        radial-gradient(circle at 1px 1px, rgba(255,255,255,.07) 1px, transparent 1px);
      background-size: 22px 22px;
      opacity:.09;
      mix-blend-mode: overlay;
    }
    button, input, select, textarea{font:inherit;color:inherit}
    .app{max-width:1550px;margin:0 auto;padding:18px 16px 28px;}
    .topbar{
      display:flex;gap:12px;align-items:center;justify-content:space-between;
      padding:14px 14px;
      background:
        radial-gradient(900px 260px at 10% 20%, rgba(79,156,255,.22), transparent 60%),
        radial-gradient(700px 240px at 85% 30%, rgba(168,85,247,.18), transparent 62%),
        radial-gradient(700px 260px at 65% 120%, rgba(53,208,127,.14), transparent 65%),
        linear-gradient(180deg, rgba(14,22,40,.92), rgba(10,16,30,.86));
      border:1px solid rgba(255,255,255,.14);
      border-radius:var(--radius);
      box-shadow: var(--shadow);
      position: sticky; top: 0; backdrop-filter: blur(10px); z-index: 10;
      overflow:hidden;
      isolation:isolate;
    }
        .topbar > *{position:relative;z-index:1}
.brand{display:flex;gap:12px;align-items:center;min-width:260px;}
    .logo{
      width:42px;height:42px;border-radius:14px;
      background: linear-gradient(135deg, rgba(79,156,255,.95), rgba(79,156,255,.25));
      border:1px solid rgba(255,255,255,.18);
      box-shadow: 0 10px 25px rgba(79,156,255,.18);
    
      display:grid;place-items:center;
      color: rgba(255,255,255,.92);
      overflow:hidden;
    }
    .title{display:flex;flex-direction:column;line-height:1.15}
    .title b{font-size:15px;letter-spacing:.2px}
    .title span{font-size:12px;color:var(--muted)}
    .controls{display:flex;gap:10px;align-items:center;flex-wrap:wrap;justify-content:flex-end}
    .tabs{
      display:flex; gap:8px; align-items:center;
      background: rgba(255,255,255,.04);
      border:1px solid var(--line);
      padding:6px;
      border-radius:999px;
    }
    .tab{
      border:0;background:transparent;padding:9px 12px;border-radius:999px;
      cursor:pointer;color:var(--muted)
    }
    .tab.active{background: rgba(255,255,255,.08);color: var(--text);border:1px solid rgba(255,255,255,.10)}
    .pill{
      display:flex; gap:8px; align-items:center;
      background: rgba(255,255,255,.04);
      border:1px solid rgba(255,255,255,.10);
      padding:10px 10px;
      border-radius:999px;
      color: var(--muted);
      font-size:12px;
    }
    .pill input{border:0;outline:0;background:transparent;color:var(--text);min-width:220px}
    .btn{
      border:1px solid var(--line);
      background: rgba(255,255,255,.065);
      padding:10px 12px;
      border-radius:999px;
      cursor:pointer;
      transition:.15s ease;
      display:inline-flex;
      gap:8px;
      align-items:center;
      white-space:nowrap;
    }
    .btn:hover{transform:translateY(-1px); background: rgba(255,255,255,.08)}
    .btn:disabled{opacity:.45; cursor:not-allowed; transform:none}
    .btn.primary{
      background: linear-gradient(135deg, rgba(79,156,255,.92), rgba(79,156,255,.35));
      border:1px solid rgba(79,156,255,.55);
      box-shadow: 0 10px 24px rgba(79,156,255,.18);
    }
    .btn.danger{
      background: linear-gradient(135deg, rgba(255,91,91,.9), rgba(255,91,91,.25));
      border:1px solid rgba(255,91,91,.55);
    }
    .dot{width:8px;height:8px;border-radius:999px;background:rgba(255,255,255,.25)}
    .dot.good{background:var(--good)} .dot.mid{background:var(--mid)} .dot.bad{background:var(--bad)}
    .content{margin-top:14px;}
    .grid2{display:grid;grid-template-columns: 1.25fr .75fr;gap:12px;}
    @media(max-width:980px){.grid2{grid-template-columns:1fr}.pill input{min-width:160px}.brand{min-width:0}}
    .panel{
      background: linear-gradient(180deg, rgba(255,255,255,.065), rgba(255,255,255,.03));
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 12px;
    }
    .panel h3{margin:6px 0 10px;font-size:14px;letter-spacing:.2px}
    .hr{height:1px;background:rgba(255,255,255,.08);margin:10px 0}
    .muted{color:var(--muted);font-size:12px}
    /* Board */
    .board{display:flex;gap:12px;overflow-x:auto;padding-bottom:10px;}
    .col{
      min-width:320px;
      background: linear-gradient(180deg, rgba(255,255,255,.065), rgba(255,255,255,.03));
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding:12px;
    }
    .col-header{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      padding:6px 4px 10px;border-bottom:1px dashed rgba(255,255,255,.10);margin-bottom:10px;
    }
    .col-header b{font-size:13px}
    .badge{
      font-size:12px;padding:6px 10px;border-radius:999px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      color: var(--muted);
    }
    .dropzone{min-height:60px;display:flex;flex-direction:column;gap:10px;padding:2px;border-radius: var(--radius2);}
    .dropzone.dragover{outline:2px dashed rgba(79,156,255,.55);outline-offset:4px;background:rgba(79,156,255,.06)}
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.03));
      border:1px solid rgba(255,255,255,.10);
      border-radius: var(--radius2);
      padding:10px;
      box-shadow: 0 10px 20px rgba(0,0,0,.25);
      cursor: grab;
    }
    .card.readonly{cursor:default}
    .card-top{display:flex;align-items:flex-start;justify-content:space-between;gap:10px;margin-bottom:8px;}
    .bm-id{
      font-family:var(--mono);font-size:12px;letter-spacing:.2px;
      background: rgba(26,42,73,.7);
      border:1px solid rgba(255,255,255,.10);
      padding:6px 8px;border-radius:10px;
      display:inline-flex;gap:8px;align-items:center;
      max-width:260px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;
    }
    .meta{display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin-top:8px;}
    .chip{
      font-size:12px;padding:6px 8px;border-radius:999px;
      background: rgba(26,42,73,.55);
      border:1px solid rgba(255,255,255,.10);
      color: var(--muted);
      display:inline-flex;gap:6px;align-items:center;
    }
    .chip strong{color:var(--text);font-weight:600}
    .qdot{width:8px;height:8px;border-radius:999px;display:inline-block;}
    .qdot.good{background:var(--good)} .qdot.mid{background:var(--mid)} .qdot.bad{background:var(--bad)}
    .small{font-size:12px;color:var(--muted);line-height:1.35;}
    .iconbtn{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.065);
      width:36px;height:36px;border-radius:12px;
      cursor:pointer;display:grid;place-items:center;
    }
    .iconbtn:disabled{opacity:.45; cursor:not-allowed}
    .warn{color: rgba(255,91,91,.92);font-weight:600;}
    /* Table */
    .table{
      width:100%;
      border-collapse:separate;border-spacing:0;
      overflow:hidden;border:1px solid rgba(255,255,255,.10);
      border-radius: 14px;background: rgba(255,255,255,.03);
    }
    .table th,.table td{padding:10px;border-bottom:1px solid rgba(255,255,255,.08);font-size:12px;vertical-align:middle}
    .table th{color:var(--muted);background:rgba(255,255,255,.03);text-align:left;position:sticky;top:0;z-index:1}
    .table tr:last-child td{border-bottom:0}
    .cell{
      width:100%;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
      border-radius:10px;
      padding:8px 8px;
      outline:none;
      font-size:12px;
    }
    .cell:focus{box-shadow: var(--focus); border-color: rgba(79,156,255,.55)}
    .cell:disabled{opacity:.55}
    pre.output{
      margin:0;padding:12px;border:1px solid rgba(255,255,255,.10);
      border-radius:14px;background:rgba(0,0,0,.25);
      color:var(--text);font-family:var(--mono);font-size:12px;line-height:1.5;
      min-height:420px;white-space:pre-wrap;word-break:break-word;
    }
    .toast{
      position:fixed;right:16px;bottom:16px;
      background: rgba(20,34,60,.92);
      border:1px solid rgba(255,255,255,.14);
      color: var(--text);
      padding:10px 12px;border-radius:14px;
      box-shadow: var(--shadow);
      display:none;max-width:560px;z-index:20;
    }
    .toast.show{display:block}
    /* Modal */
    .backdrop{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;place-items:center;z-index:50;padding:14px}
    .backdrop.open{display:grid}
    /* Login: fundo mais s√≥lido (n√£o deixa o app aparecer) */
    #loginBackdrop{
      background: radial-gradient(1200px 600px at 50% 0%, rgba(37,99,235,.18), rgba(2,6,23,.94));
      backdrop-filter: blur(10px) saturate(120%);
      -webkit-backdrop-filter: blur(10px) saturate(120%);
    }
    #loginBackdrop .modal{
      border: 1px solid rgba(255,255,255,.12);
      box-shadow: 0 30px 90px rgba(0,0,0,.55);
    }

    .modal{width:min(980px,100%);background:linear-gradient(180deg, rgba(16,31,54,.98), rgba(15,26,46,.98));
      border:1px solid rgba(255,255,255,.14);border-radius:18px;box-shadow:0 28px 70px rgba(0,0,0,.55);overflow:hidden}
    .modal-header{padding:14px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid rgba(255,255,255,.10);background:rgba(255,255,255,.03)}
    .modal-body{padding:14px;display:grid;grid-template-columns:1.15fr .85fr;gap:12px}
    @media(max-width:920px){.modal-body{grid-template-columns:1fr}}
    .modal-footer{padding:14px;display:flex;justify-content:space-between;gap:10px;border-top:1px solid rgba(255,255,255,.10);background:rgba(255,255,255,.03);flex-wrap:wrap}
    .field{display:flex;flex-direction:column;gap:6px;padding:10px;border:1px solid rgba(255,255,255,.10);border-radius:14px;background:rgba(255,255,255,.03)}
    .field label{font-size:12px;color:var(--muted)}
  
    /* Admin-only tabs hidden by default (mostra via JS quando editor) */
    .tab.admin{ display:none; }

    /* Fix dropdown (select/options) em tema escuro */
    :root{ color-scheme: dark; }
    select{ background-color: rgba(255,255,255,.04); color: var(--text); }
    select option{ background-color: #0b1220; color: #e7eefc; }

  
    /* --- Suporte --- */
    .support-fab{
      position:fixed;right:16px;bottom:16px;z-index:50;
      width:54px;height:54px;border-radius:18px;
      border:1px solid rgba(255,255,255,.14);
      background: linear-gradient(135deg, rgba(79,156,255,.95), rgba(79,156,255,.25));
      box-shadow: 0 18px 40px rgba(79,156,255,.18);
      cursor:pointer;
      display:flex;align-items:center;justify-content:center;
      user-select:none;
    }
    .support-fab:active{transform:translateY(1px)}
    .support-fab span{font-size:20px}
    .inbox-item{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
      border-radius:14px;
      padding:10px;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .inbox-top{display:flex;align-items:flex-start;justify-content:space-between;gap:10px}
    .inbox-meta{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
    .tag{
      font-size:12px;padding:6px 10px;border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(26,42,73,.55);
      color: var(--muted);
      display:inline-flex;gap:6px;align-items:center;
    }
    .tag strong{color:var(--text)}

  
    /* --- Suportes (profissional e organizado) --- */
    .tab .badge{ margin-left:8px; }
    .tab.attn{ border-color: rgba(79,156,255,.65); box-shadow: 0 0 0 2px rgba(79,156,255,.14); }
    .support-msg{
      background: rgba(255,255,255,.03);
      border:1px solid rgba(255,255,255,.08);
      border-radius:12px;
      padding:10px;
      white-space:pre-wrap;
      line-height:1.35;
    }
    .support-grid{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .support-ops summary{ cursor:pointer; color: var(--muted); }
    .support-ops summary:hover{ color: var(--text); }

  
  .bm-details{
    border:1px solid rgba(255,255,255,.10);
    border-radius:16px;
    padding:10px 12px;
    background: rgba(255,255,255,.04);
  }
  .bm-details > summary{
    cursor:pointer;
    list-style:none;
    font-weight:600;
    opacity:.95;
  }
  .bm-details > summary::-webkit-details-marker{ display:none; }


  /* Dashboard bars */
  .barlist{ display:flex; flex-direction:column; gap:10px; }
  .barrow{ display:grid; grid-template-columns: 160px 1fr 120px; gap:12px; align-items:center; }
  .barlabel{ font-weight:800; }
  .barmeta{ text-align:right; font-variant-numeric: tabular-nums; }
  .bartrack{ height:12px; border-radius:999px; background: rgba(255,255,255,.08); overflow:hidden; border:1px solid rgba(255,255,255,.10); }
  .barfill{ height:100%; border-radius:999px; background: linear-gradient(90deg, rgba(79,156,255,.75), rgba(79,156,255,.18)); }
  .kpiRow{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
  .kpiBox{ padding:10px 12px; border-radius:14px; background: rgba(255,255,255,.04); border:1px solid rgba(255,255,255,.08); }
  .kpiBox .t{ font-size:12px; opacity:.78; }
  .kpiBox .v{ font-size:18px; font-weight:900; margin-top:4px; }



  /* Dashboard: filtros fixos + KPIs executivos */
  .dashFilters{ position: sticky; top: 86px; z-index: 9; backdrop-filter: blur(10px); }
  .dashExecRow .kpiBox{ flex:1; min-width:220px; }
  @media (max-width: 720px){
    .dashFilters{ position: static; }
  }
  /* Dashboard drilldown */
  .metaInput{width:110px; padding:8px 10px; border-radius:12px; border:1px solid rgba(255,255,255,.12); background:rgba(0,0,0,.25); color:var(--text); outline:none; }
  .metaTag{ font-weight:800; }
  .metaSmall{ font-size:12px; opacity:.78; }
  .rowCompact{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }

  .barrow{ cursor:pointer; }
  .barrow:hover{ background: rgba(255,255,255,.03); border-radius:14px; padding:6px 8px; margin:-6px -8px; }

    /* Dashboard detalhe: lista curta + expandir */
    .dashDetailScroll{max-height:260px; overflow:auto;}
    #dashDetailToggle{margin-top:10px;}
    /* Trend tooltip (Dashboard) */
    .trendTooltip{
      position:absolute;
      z-index:30;
      display:none;
      pointer-events:none;
      background: rgba(7, 12, 24, .92);
      border: 1px solid rgba(255,255,255,.14);
      box-shadow: var(--shadow);
      padding: 10px 12px;
      border-radius: 14px;
      min-width: 180px;
      max-width: 260px;
      backdrop-filter: blur(8px);
    }
    .trendTooltip .ttTitle{font-weight:800; letter-spacing:.2px; margin-bottom:6px}
    .trendTooltip .ttRow{display:flex; align-items:center; justify-content:space-between; gap:14px; margin:3px 0}
    .trendTooltip .ttRow span{color: var(--muted); font-size:12px}
    .trendTooltip .ttRow b{font-family: var(--mono); font-size:12px}
    .trendTooltip .ttHint{margin-top:6px; color: var(--muted); font-size:11px}


    /* Performance mode */
    body.perf{ background: var(--bg) !important; }
    body.perf .topbar{ backdrop-filter:none !important; }
    body.perf .panel, body.perf .col, body.perf .card, body.perf .toast, body.perf .modal{ box-shadow:none !important; }
    body.perf .btn, body.perf .iconbtn{ transition:none !important; }
    body.perf .btn:hover{ transform:none !important; }
    body.perf .dropzone.dragover{ outline-offset:2px !important; }
    @media (prefers-reduced-motion: reduce){
      *{ scroll-behavior:auto !important; transition:none !important; animation:none !important; }
    }

  

    /* UI PRO (fundo + tela inicial) */
    body::before{
      content:"";
      position:fixed;
      inset:0;
      pointer-events:none;
      background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%27http%3A//www.w3.org/2000/svg%27%20width%3D%27120%27%20height%3D%27120%27%20viewBox%3D%270%200%20120%20120%27%3E%0A%20%20%3Cdefs%3E%0A%20%20%20%20%3CradialGradient%20id%3D%27a%27%20cx%3D%2730%25%27%20cy%3D%2725%25%27%20r%3D%2780%25%27%3E%0A%20%20%20%20%20%20%3Cstop%20offset%3D%270%27%20stop-color%3D%27%234f9cff%27%20stop-opacity%3D%270.35%27/%3E%0A%20%20%20%20%20%20%3Cstop%20offset%3D%271%27%20stop-color%3D%27%234f9cff%27%20stop-opacity%3D%270%27/%3E%0A%20%20%20%20%3C/radialGradient%3E%0A%20%20%3C/defs%3E%0A%20%20%3Crect%20width%3D%27120%27%20height%3D%27120%27%20fill%3D%27url%28%23a%29%27%20opacity%3D%270.35%27/%3E%0A%20%20%3Cg%20fill%3D%27%23ffffff%27%20fill-opacity%3D%270.10%27%3E%0A%20%20%20%20%3Ccircle%20cx%3D%276%27%20cy%3D%276%27%20r%3D%271%27/%3E%3Ccircle%20cx%3D%2730%27%20cy%3D%276%27%20r%3D%271%27/%3E%3Ccircle%20cx%3D%2754%27%20cy%3D%276%27%20r%3D%271%27/%3E%3Ccircle%20cx%3D%2778%27%20cy%3D%276%27%20r%3D%271%27/%3E%3Ccircle%20cx%3D%27102%27%20cy%3D%276%27%20r%3D%271%27/%3E%0A%20%20%20%20%3Ccircle%20cx%3D%276%27%20cy%3D%2730%27%20r%3D%271%27/%3E%3Ccircle%20cx%3D%2730%27%20cy%3D%2730%27%20r%3D%271%27/%3E%3Ccircle%20cx%3D%2754%27%20cy%3D%2730%27%20r%3D%271%27/%3E%3Ccircle%20cx%3D%2778%27%20cy%3D%2730%27%20r%3D%271%27/%3E%3Ccircle%20cx%3D%27102%27%20cy%3D%2730%27%20r%3D%271%27/%3E%0A%20%20%20%20%3Ccircle%20cx%3D%276%27%20cy%3D%2754%27%20r%3D%271%27/%3E%3Ccircle%20cx%3D%2730%27%20cy%3D%2754%27%20r%3D%271%27/%3E%3Ccircle%20cx%3D%2754%27%20cy%3D%2754%27%20r%3D%271%27/%3E%3Ccircle%20cx%3D%2778%27%20cy%3D%2754%27%20r%3D%271%27/%3E%3Ccircle%20cx%3D%27102%27%20cy%3D%2754%27%20r%3D%271%27/%3E%0A%20%20%20%20%3Ccircle%20cx%3D%276%27%20cy%3D%2778%27%20r%3D%271%27/%3E%3Ccircle%20cx%3D%2730%27%20cy%3D%2778%27%20r%3D%271%27/%3E%3Ccircle%20cx%3D%2754%27%20cy%3D%2778%27%20r%3D%271%27/%3E%3Ccircle%20cx%3D%2778%27%20cy%3D%2778%27%20r%3D%271%27/%3E%3Ccircle%20cx%3D%27102%27%20cy%3D%2778%27%20r%3D%271%27/%3E%0A%20%20%20%20%3Ccircle%20cx%3D%276%27%20cy%3D%27102%27%20r%3D%271%27/%3E%3Ccircle%20cx%3D%2730%27%20cy%3D%27102%27%20r%3D%271%27/%3E%3Ccircle%20cx%3D%2754%27%20cy%3D%27102%27%20r%3D%271%27/%3E%3Ccircle%20cx%3D%2778%27%20cy%3D%27102%27%20r%3D%271%27/%3E%3Ccircle%20cx%3D%27102%27%20cy%3D%27102%27%20r%3D%271%27/%3E%0A%20%20%3C/g%3E%0A%3C/svg%3E");
      background-size:220px 220px;
      opacity:.07;
      transform:translateZ(0);
    }

    .content{margin-top:14px;}

    .hero{
      display:flex;
      gap:16px;
      align-items:stretch;
      justify-content:space-between;
      padding:18px 18px;
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      background:
        radial-gradient(900px 420px at 10% 10%, rgba(79,156,255,.18), transparent 65%),
        radial-gradient(700px 360px at 85% 15%, rgba(53,208,127,.12), transparent 60%),
        linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.03));
      position:relative;
      overflow:hidden;
    }
    .hero::after{
      content:"";
      position:absolute;
      inset:-40px -80px auto auto;
      width:420px;
      height:260px;
      background:radial-gradient(circle at 30% 30%, rgba(247,201,72,.16), transparent 62%);
      opacity:.9;
      pointer-events:none;
    }
    .hero-left{min-width:420px; flex: 1;}
    .hero-title{display:flex; align-items:center; gap:10px;}
    .hero-title h1{margin:0; font-size:20px; letter-spacing:.2px;}
    .hero-title .tag{
      font-size:11px;
      color:var(--muted);
      border:1px solid rgba(255,255,255,.12);
      padding:6px 10px;
      border-radius:999px;
      background:rgba(0,0,0,.10);
    }
    .hero p{margin:8px 0 0; color:var(--muted); font-size:13px; max-width:72ch; line-height:1.35;}

    .kpi-row{display:flex; flex-wrap:wrap; gap:10px; margin-top:14px;}
    .kpi{
      flex:1;
      min-width:170px;
      border:1px solid rgba(255,255,255,.10);
      border-radius:14px;
      background:rgba(9,14,25,.28);
      padding:10px 12px;
      backdrop-filter: blur(6px);
    }
    .kpi .label{font-size:11px; color:var(--muted); margin-bottom:4px;}
    .kpi b{font-size:18px; letter-spacing:.2px;}
    .kpi .sub{font-size:11px; color:var(--muted); margin-top:2px;}

    .hero-right{width:340px; min-width:280px; display:flex; flex-direction:column; gap:10px;}
    .quick{
      border:1px solid rgba(255,255,255,.10);
      border-radius:16px;
      background:rgba(9,14,25,.24);
      padding:12px;
    }
    .quick h4{margin:0 0 8px; font-size:12px; color:var(--muted); letter-spacing:.25px;}
    .quick .qgrid{display:grid; grid-template-columns:1fr; gap:8px;}
    .btn.full{width:100%; display:flex; justify-content:center;}

    @media (max-width: 980px){
      .hero{flex-direction:column;}
      .hero-left{min-width:auto;}
      .hero-right{width:auto;}
    }

    /* --- Layout PRO: Sidebar + Conte√∫do --- */
    .app.shell{max-width:1550px;margin:0 auto;padding:18px 16px 28px;display:grid;grid-template-columns:270px 1fr;gap:14px;align-items:start}
    .main{min-width:0}
    .sidebar{
      position:sticky; top:18px;
      height: calc(100vh - 36px);
      overflow:auto;
      border:1px solid rgba(255,255,255,.14);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      background:
        radial-gradient(900px 320px at 20% 10%, rgba(79,156,255,.18), transparent 60%),
        radial-gradient(700px 280px at 80% 22%, rgba(168,85,247,.14), transparent 62%),
        linear-gradient(180deg, rgba(14,22,40,.92), rgba(10,16,30,.86));
      padding:12px;
    }
    .side-head{display:flex;gap:10px;align-items:center;padding:6px 6px 12px;border-bottom:1px solid rgba(255,255,255,.10);margin-bottom:10px}
    .side-logo{
      width:40px;height:40px;border-radius:14px;
      background: linear-gradient(135deg, rgba(79,156,255,.95), rgba(79,156,255,.25));
      border:1px solid rgba(255,255,255,.18);
      box-shadow: 0 10px 25px rgba(79,156,255,.18);
      flex:0 0 auto;
    
      display:grid;place-items:center;
      color: rgba(255,255,255,.92);
      overflow:hidden;
    }
    .logo svg, .side-logo svg{
      width:70%;
      height:70%;
      display:block;
      filter: drop-shadow(0 6px 18px rgba(0,0,0,.35));
    }

    .side-title{display:flex;flex-direction:column;line-height:1.15}
    .side-title b{font-size:14px;letter-spacing:.2px}
    .side-section{margin-top:12px}
    .side-section-title{
      font-size:11px; letter-spacing:.22em; text-transform:uppercase;
      color: var(--muted);
      margin:10px 6px 8px;
    }
    .side-nav{display:flex;flex-direction:column;gap:8px}
    .sidebar .tab{
      width:100%;
      text-align:left;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      padding:10px 12px;
      border-radius:14px;
      cursor:pointer;
      color: var(--muted);
      display:flex;align-items:center;justify-content:space-between;gap:10px;
    }
    .sidebar .tab:hover{background: rgba(255,255,255,.06)}
    .sidebar .tab.active{
      background: linear-gradient(135deg, rgba(79,156,255,.42), rgba(79,156,255,.14));
      border-color: rgba(79,156,255,.55);
      color: var(--text);
      box-shadow: 0 10px 24px rgba(79,156,255,.10);
    }

    /* --- UX Polimento (sem mexer no exec) --- */
    /* 4) Status/Usu√°rio mais "sistema" (por role) */
    #modePill{ border-color: rgba(255,255,255,.12); }
    body.role-leitor #modePill{
      background: linear-gradient(135deg, rgba(79,156,255,.18), rgba(79,156,255,.06));
      border-color: rgba(79,156,255,.35);
      color: rgba(231,238,252,.95);
    }
    body.role-editor #modePill{
      background: linear-gradient(135deg, rgba(53,208,127,.16), rgba(53,208,127,.06));
      border-color: rgba(53,208,127,.35);
      color: rgba(231,238,252,.95);
    }
    body.role-supervisor #modePill{
      background: linear-gradient(135deg, rgba(168,85,247,.16), rgba(168,85,247,.06));
      border-color: rgba(168,85,247,.38);
      color: rgba(231,238,252,.95);
    }
    body.role-supervisor #modeDot{ background: rgba(168,85,247,.95) !important; }

    /* 7) Respiro (sem mexer em estrutura) */
    .grid2{gap:14px;}
    .panel{padding:14px;}
    .main .content{padding:0 2px;}
    .content{max-width: 1420px; margin:14px auto 0;}
    @media(max-width:980px){ .content{max-width: unset; margin-top:12px;} }

    /* 6) Legenda compacta */
    .legend{display:flex;flex-direction:column;gap:6px;margin-top:10px}
    .legend .row{display:flex;align-items:center;gap:10px;color:var(--muted);font-size:12px}
    .legend .sw{width:10px;height:10px;border-radius:999px}
    .side-footer{margin-top:14px;padding:10px;border-top:1px solid rgba(255,255,255,.10)}
    /* Topbar mais limpa */
    .topbar.topbar-mini .tabs{display:none !important;}
    /* Mobile: Sidebar vira navega√ß√£o horizontal (sem JS) */
    @media(max-width:980px){
      .app.shell{grid-template-columns:1fr;gap:12px}
      .sidebar{
        position:sticky; top:0;
        height:auto;
        padding:10px;
        z-index:12;
      }
      .side-head{display:none}
      .side-footer{display:none}
      .side-section-title{display:none}
      .side-nav{flex-direction:row;flex-wrap:nowrap;overflow:auto;padding-bottom:4px}
      .sidebar .tab{white-space:nowrap;width:auto;min-width:max-content;border-radius:999px}
      .sidebar .tab .badge{margin-left:8px}
      .sidebar .tab.admin{display:none;} /* ser√° exibido via JS ao virar editor (JS existente) */
    }

/* --- UI PRO: Agenda foco Programa√ß√£o --- */
.gridAgenda{display:grid;grid-template-columns: 1fr;gap:12px;}
@media(max-width:980px){.gridAgenda{grid-template-columns:1fr}}
.agenda-prog details > summary{
  display:flex;align-items:center;justify-content:space-between;gap:12px;
  padding:10px 10px;border-radius:14px;
  border:1px solid rgba(255,255,255,.08);
  background: rgba(255,255,255,.02);
}
.agenda-prog details[open] > summary{background: rgba(79,156,255,.06); border-color: rgba(79,156,255,.18);}
.agenda-prog details{margin-bottom:10px}
.agenda-prog details > summary::-webkit-details-marker{display:none}

/* --- UI PRO: Dashboard detalhes + estado vazio + Top 3 --- */
#dashEmpty{display:none}
.dashSummary{margin-top:12px}
.dashTop3{display:flex;flex-direction:column;gap:8px;margin-top:10px}
.dashTop3Item{
  display:flex;align-items:center;justify-content:space-between;gap:12px;
  padding:10px 12px;border-radius:14px;
  border:1px solid rgba(255,255,255,.10);
  background: rgba(255,255,255,.03);
}
.dashTop3Item b{font-variant-numeric: tabular-nums;}
details.panel > summary{
  cursor:pointer;
  list-style:none;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
  font-weight:800;
}
details.panel > summary::-webkit-details-marker{display:none}
details.panel[open] > summary{margin-bottom:10px}

    /* Agenda: atalhos Hoje / Amanh√£ (compacto e bonito) */
    .daySwitch{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-top:10px}
    .daySwitch .dayHint{font-weight:700;color:var(--muted)}
    .dayBtn{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      padding:6px 10px;
      border-radius:999px;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:8px;
      font-weight:800;
      font-size:12px;
      letter-spacing:0;
      user-select:none;
      transition:.15s ease;
      line-height:1.1;
    }
    .dayBtn:hover{ background: rgba(255,255,255,.06); transform:translateY(-1px); }
    .dayBtn.active{
      background: linear-gradient(135deg, rgba(79,156,255,.22), rgba(79,156,255,.08));
      border-color: rgba(79,156,255,.45);
      box-shadow: 0 10px 22px rgba(79,156,255,.12);
    }
    .dayBtn .dayDate{
      font-weight:700;
      color: var(--muted);
      font-size:12px;
      letter-spacing:0;
    }
    .dayBtn .icon{font-size:13px;line-height:1;}


/* Agenda - resumo mais claro (hoje/amanh√£ + tabela r√°pida) */
.agenda-focus{
  display:grid;
  grid-template-columns:repeat(2,minmax(0,1fr));
  gap:12px;
  margin:12px 0 10px;
}
@media (max-width: 900px){
  .agenda-focus{ grid-template-columns:1fr; }
}
.focusCard{
  background: rgba(255,255,255,.03);
  border: 1px solid var(--line);
  border-radius: 16px;
  padding: 12px 14px;
  box-shadow: var(--shadow);
  overflow:hidden;
}
.focusCard .d{
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:10px;
  margin-bottom:6px;
}
.focusCard .t{
  font-size: 22px;
  font-weight: 900;
  letter-spacing: -0.02em;
  line-height: 1.1;
}
.focusCard .meta{
  margin-top: 8px;
  display:flex;
  flex-wrap:wrap;
  gap:8px;
}
.focusCard .meta .pill{
  display:inline-flex;
  align-items:center;
  gap:6px;
  padding:4px 10px;
  border:1px solid var(--line);
  border-radius:999px;
  background: rgba(255,255,255,.03);
  font-size: 12px;
  color: var(--muted);
}
.agendaResumo{ margin-top: 10px; }
.agendaResumo .table td{ vertical-align: top; }
.agendaResumo .rowToday{
  background: linear-gradient(135deg, rgba(79,156,255,.14), rgba(79,156,255,.04));
}
.agendaResumo .rowTomorrow{
  background: linear-gradient(135deg, rgba(0,214,170,.10), rgba(0,214,170,.03));
}
.agendaResumo .empLine{
  color: var(--muted);
  font-size: 13px;
  line-height: 1.25;
}

    /* Bulk selection */
    #progSelectAll{ width:16px; height:16px; accent-color: var(--accent); }
    .progSel{ width:16px; height:16px; accent-color: var(--accent); }
</style>
</head>
<body>
  <div class="app shell">
    <aside class="sidebar" id="sidebar">
      <div class="side-head">
        <div class="side-logo" aria-hidden="true"><svg viewBox="0 0 64 64" role="img" aria-label="Logo" focusable="false">
  <path d="M20 40c4.8 0 8.5-4.2 13-10.2C37.6 23.6 41.2 19 45 19c6.6 0 12 5.4 12 12s-5.4 12-12 12c-4.8 0-8.5-4.2-13-10.2C26.4 26.6 22.8 22 19 22c-6.6 0-12 5.4-12 12s5.4 12 12 12z"
        fill="none" stroke="currentColor" stroke-width="4.2" stroke-linecap="round" stroke-linejoin="round"/>
</svg></div>
        <div class="side-title">
          <b>Planejamento Parceiros</b>
          <span class="muted" style="margin-top:2px">Menu</span>
        </div>
      </div>

      <div class="side-section">
        <div class="side-section-title">OPERACIONAL</div>
        <div class="side-nav">
          <button class="tab active" id="tabAgenda">üìÖ Agenda</button>
          <button class="tab" id="tabRodizio">üîÑ Rod√≠zio do dia</button>
          <button class="tab" id="tabBoard">üóÇÔ∏è BMs</button>
        </div>
      </div>

      <div class="side-section">
        <div class="side-section-title">CONTROLE</div>
        <div class="side-nav">
          <button class="tab admin" id="tabProg">üßæ Programa√ß√£o</button>
          <button class="tab admin" id="tabSupport">üõü Suportes <span class="badge" id="supportBadge" style="display:none">0</span></button>
        </div>
      </div>

      <div class="side-section">
        <div class="side-section-title">GEST√ÉO</div>
        <div class="side-nav">
          <button class="tab" id="tabDash">üìä Dashboard</button>
        </div>
      </div>

    </aside>

    <div class="main">
<div class="topbar topbar-mini">
      <div class="brand">
        <div class="logo" aria-hidden="true"><svg viewBox="0 0 64 64" role="img" aria-label="Logo" focusable="false">
  <path d="M20 40c4.8 0 8.5-4.2 13-10.2C37.6 23.6 41.2 19 45 19c6.6 0 12 5.4 12 12s-5.4 12-12 12c-4.8 0-8.5-4.2-13-10.2C26.4 26.6 22.8 22 19 22c-6.6 0-12 5.4-12 12s5.4 12 12 12z"
        fill="none" stroke="currentColor" stroke-width="4.2" stroke-linecap="round" stroke-linejoin="round"/>
</svg></div>
        <div class="title">
          <b>Planejamento Parceiros</b>
          <span id="subtitleReader">ONLINE ‚Ä¢ Acesso por login (Leitor/Editor/Supervisor)</span>
          <span id="subtitleEditor" style="display:none">ONLINE ‚Ä¢ Edi√ß√£o (controle por login)</span>
        </div>
      </div>

      <div class="controls">
        <div class="pill" id="modePill" title="Status">
          <span class="dot" id="modeDot"></span>
          <span id="modeText">Carregando‚Ä¶</span>
        </div>

        <div class="pill" id="userPill" title="Usu√°rio" style="display:none">
          üë§ <span id="userLabel">‚Äî</span>
        </div>
        <button class="btn" id="btnLogout" style="display:none" title="Sair">Sair</button>
        <button class="btn primary" id="btnLogin" style="display:none" title="Entrar">Entrar</button>

        <div class="pill">
          üîé <input id="search" placeholder="Buscar..." />
        </div>

        <button class="btn primary" id="btnAdd" disabled>Ôºã Nova BM</button>
        <button class="btn" id="btnRefresh">Recarregar</button>
        <button class="btn primary" id="btnSave" disabled>Salvar</button>
        <button class="btn" id="btnPerf" title="Ativa/desativa modo performance">‚ö° Performance</button>
        <button class="btn" id="btnLock" style="display:none" title="Remove a chave deste navegador e volta para leitura">üîí Bloquear</button>
      </div>
    </div>

    <div class="content">
      <!-- BOARD -->
      <div id="viewBoard" style="display:none">
        <div class="panel" style="margin-bottom:12px">
          <div class="controls" style="justify-content:space-between;align-items:center">
            <div class="controls" style="justify-content:flex-start">
              <div class="pill"><span>üè¢ Empresa</span>
                <select id="bmEmpresaFilter" style="border:0;outline:0;background:transparent;color:var(--text)">
                  <option value="ALL">Todas</option>
                  <option value="GBR_CLT">GBR CLT</option>
                  <option value="GBR_NOVO">GBR NOVO</option>
                  <option value="3P_CLT">3P CLT</option>
                  <option value="3P_PORT">3P PORT</option>
                  <option value="M2_PORT">M2 PORT</option>
                  <option value="2A_PORT">2A PORT</option>
                  <option value="VMC_PORT">VMC PORT</option>
                  <option value="SEM">Sem empresa</option>
                </select>
              </div>
              <div class="muted" style="margin-left:6px">Filtro vale para todas as colunas.</div>
            </div>
            <div class="controls">
              <span class="chip"><strong id="bmCount">0</strong> BMs</span>
            </div>
          </div>
        </div>
        <div class="board" id="board"></div>
      </div>

      <!-- AGENDA -->
      <!-- DASHBOARD -->
      <div id="viewDash" style="display:none">
        <div class="panel dashFilters" id="dashFilters" style="margin-bottom:12px">
          <div class="controls" style="justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap">
            <div class="controls" style="justify-content:flex-start;gap:10px;flex-wrap:wrap">
              <div class="pill"><span>üìÖ De</span><input id="dashFrom" type="date" style="min-width:140px"></div>
              <div class="pill"><span>At√©</span><input id="dashTo" type="date" style="min-width:140px"></div>
              <div class="pill"><span>üîΩ</span>
                <select id="dashQuick" style="border:0;outline:0;background:transparent;color:var(--text)">
                  <option value="7">Pr√≥ximos 7 dias</option>
                  <option value="today">Hoje</option>
                  <option value="tomorrow">Amanh√£</option>
                  <option value="all">Tudo</option>
                </select>
              </div>
              <div class="pill"><span>üè¢</span>
                <select id="dashEmpresa" style="border:0;outline:0;background:transparent;color:var(--text)">
                  <option value="ALL">Todas empresas</option>
                  <option value="GBR_CLT">GBR CLT</option>
                  <option value="GBR">GBR</option>
                  <option value="3P_CLT">3P CLT</option>
                  <option value="3P_PORT">3P PORT</option>
                  <option value="M2_PORT">M2 PORT</option>
                  <option value="2A_PORT">2A PORT</option>
                  <option value="VMC_PORT">VMC PORT</option>
                </select>
              </div>
              <div class="pill"><span>üìå</span>
                <select id="dashProduto" style="border:0;outline:0;background:transparent;color:var(--text)">
                  <option value="ALL">Todos produtos</option>
                  <option value="CLT">CLT</option>
                  <option value="NOVO">NOVO</option>
                  <option value="PORT">PORT</option>
                </select>
              </div>
              <button class="btn" id="dashCopyDay" title="Copia um resumo do dia selecionado">Copiar resumo</button>
              <button class="btn" id="dashApply">Recalcular</button>
            </div>
            <div class="controls" style="justify-content:flex-end;gap:8px;flex-wrap:wrap">
              <span class="chip"><strong id="dashTotalQty">0</strong> disparos</span>
              <span class="chip"><strong id="dashTotalLines">0</strong> linhas</span>
            </div>
          </div>
          <div class="muted" style="margin-top:8px">Fonte: Programa√ß√£o (4 d√≠gitos + quantidade + hor√°rio). Use os filtros acima para ver por empresa e por data.</div>
          <div class="kpiRow dashExecRow" style="margin-top:12px">
            <div class="kpiBox">
              <div class="t">Total do per√≠odo</div>
              <div class="v" id="dashExecTotal">‚Äî</div>
              <div class="metaSmall" id="dashExecTotalSub"></div>
            </div>
            <div class="kpiBox">
              <div class="t">M√©dia por dia</div>
              <div class="v" id="dashExecAvg">‚Äî</div>
              <div class="metaSmall" id="dashExecAvgSub"></div>
            </div>
            <div class="kpiBox">
              <div class="t">L√≠der do per√≠odo</div>
              <div class="v" id="dashExecLeader">‚Äî</div>
              <div class="metaSmall" id="dashExecLeaderSub"></div>
            </div>
            <div class="kpiBox">
              <div class="t">Vs per√≠odo anterior</div>
              <div class="v" id="dashExecDelta">‚Äî</div>
              <div class="metaSmall" id="dashExecDeltaSub"></div>
            </div>
          </div>
        </div>


        <div class="panel" id="dashEmpty" style="margin-top:12px">
          <h3 style="margin:0">Sem dados para o per√≠odo</h3>
          <div class="muted" style="margin-top:6px">N√£o encontramos disparos com os filtros atuais. Dica: selecione <b>Tudo</b> no filtro r√°pido ou ajuste as datas.</div>
        </div>

        <div id="dashNonEmpty">

        <div class="panel" id="dashTrendPanel" style="margin-top:12px">
          <div class="controls" style="justify-content:space-between;align-items:flex-start;gap:10px;flex-wrap:wrap">
            <div>
              <h3 style="margin:0">Tend√™ncia (√∫ltimos 7 dias)</h3>
              <div class="muted" style="margin-top:6px">Linha do total di√°rio + Top 2 empresas do per√≠odo selecionado.</div>
            </div>
            <div class="controls" style="justify-content:flex-end;gap:8px;flex-wrap:wrap">
              <span class="chip"><strong id="dashTrendSum">0</strong> disparos (7d)</span>
              <span class="chip"><strong id="dashTrendLeader">‚Äî</strong></span>
            </div>
          </div>
          <div class="hr" style="margin-top:12px"></div>
          <canvas id="dashTrendCanvas" height="120" style="width:100%;display:block"></canvas>
          <div class="muted" id="dashTrendHint" style="margin-top:10px"></div>
        </div>



        <details class="panel" id="dashDetails" style="margin-top:12px">
          <summary>
            <span>Ver detalhes (comparativos ‚Ä¢ metas ‚Ä¢ semana ‚Ä¢ resumos)</span>
            <span class="muted">Expandir</span>
          </summary>
          <div class="hr" style="margin-top:12px"></div>

          <div class="panel" style="margin-top:12px">
          <div class="controls" style="justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap">
            <div>
              <h3 style="margin:0">Comparativo do dia</h3>
              <div class="muted" style="margin-top:6px">Compara√ß√£o entre empresas no mesmo dia (quantidade e participa√ß√£o).</div>
            </div>
            <div class="controls" style="justify-content:flex-end;gap:10px;flex-wrap:wrap">
              <div class="pill"><span>üìÖ Dia</span>
                <select id="dashDay" style="border:0;outline:0;background:transparent;color:var(--text);min-width:160px">
                  <option value="">‚Äî</option>
                </select>
              </div>
            </div>
          </div>

          <div class="kpiRow" style="margin-top:12px">
            <div class="kpiBox"><div class="t">Total no dia</div><div class="v" id="dashDayTotal">‚Äî</div></div>
            <div class="kpiBox"><div class="t">L√≠der do dia</div><div class="v" id="dashDayLeader">‚Äî</div></div>
            <div class="kpiBox"><div class="t">Dif. Top 1 vs Top 2</div><div class="v" id="dashDayGap">‚Äî</div></div>
            <div class="kpiBox"><div class="t">Vs dia anterior</div><div class="v" id="dashDayVsPrev">‚Äî</div></div>
            <div class="kpiBox"><div class="t">Semana (5d) vs anterior</div><div class="v" id="dashWeekVsPrev">‚Äî</div></div>
          </div>

          <div class="panel dashSummary">
            <div class="controls" style="justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap">
              <div>
                <h3 style="margin:0">Top 3 do dia</h3>
                <div class="muted" style="margin-top:6px">Empresas com maior volume no dia selecionado.</div>
              </div>
            </div>
            <div id="dashTop3" class="dashTop3"></div>
          </div>

          <div class="hr" style="margin-top:12px"></div>
          <div id="dashDayBars" class="barlist"></div>
          <div class="muted" id="dashDayHint" style="margin-top:10px"></div>
        </div>



        <div class="panel" style="margin-top:12px">
          <div class="controls" style="justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap">
            <div>
              <h3 style="margin:0">Meta do dia</h3>
              <div class="muted" style="margin-top:6px">Realizado vs meta (por empresa) no dia selecionado.</div>
            </div>
            <div class="controls" style="justify-content:flex-end;gap:8px;flex-wrap:wrap">
              <button class="btn" id="dashMetaSave" style="display:none">Salvar metas</button>
            </div>
          </div>
          <div class="hr" style="margin-top:12px"></div>
          <div id="dashMetaRows"></div>
          <div class="muted" id="dashMetaHint" style="margin-top:10px"></div>
        </div>

        <div class="panel" style="margin-top:12px">
          <div class="controls" style="justify-content:space-between;align-items:flex-start;gap:10px;flex-wrap:wrap">
            <div>
              <h3 style="margin:0">Semana (√∫ltimos 5 dias)</h3>
              <div class="muted" style="margin-top:6px">Totais por empresa nos √∫ltimos 5 dias (at√© o dia selecionado).</div>
            </div>
          </div>
          <div class="hr" style="margin-top:12px"></div>
          <div id="dashWeek5"></div>
        </div>

        <div class="grid2">
          <div class="panel">
            <h3>Envios por empresa</h3>
            <div class="muted">Linhas e totais de disparos no per√≠odo.</div>
            <div class="hr"></div>
            <div id="dashByEmpresa"></div>
          </div>
          <div class="panel">
            <h3>Envios por data</h3>
            <div class="muted">Resumo di√°rio (total + empresas com volume).</div>
            <div class="hr"></div>
            <div id="dashByDate"></div>
          </div>
        </div>

        <div class="panel" style="margin-top:12px">
          <h3>BMs criadas (vis√£o r√°pida)</h3>
          <div class="muted">Conta pelo dia de cria√ß√£o da BM (independente da programa√ß√£o).</div>
          <div class="hr"></div>
          <div id="dashBms"></div>
        </div>

        </details>

        </div><!-- /dashNonEmpty -->
      </div>


      <div id="viewAgenda">
        
        <div class="panel" style="margin-bottom:12px">
          <div style="display:flex;align-items:flex-start;justify-content:space-between;gap:12px;flex-wrap:wrap">
            <div>
              <h3 style="margin:0">Agendamentos de disparos</h3>
              <div class="muted" style="margin-top:6px">Use os atalhos de dia (Hoje/Amanh√£) para focar r√°pido. Os filtros abaixo controlam o per√≠odo e as empresas.</div>
            </div>
            <div class="controls" style="justify-content:flex-end;gap:8px;flex-wrap:wrap">
              <span class="chip"><strong id="kpiHoje">‚Äî</strong> disparos hoje</span>
              <div class="daySwitch" aria-label="Atalhos de dia">
                <span class="dayHint">Atalhos:</span>
                <button class="dayBtn" id="btnAgendaHoje" type="button" title="Focar em Hoje">
                  <span class="icon">üìÖ</span><span>Hoje</span><span class="dayDate" id="lblAgendaHoje">‚Äî</span>
                </button>
                <button class="dayBtn" id="btnAgendaAmanha" type="button" title="Focar em Amanh√£">
                  <span class="icon">‚û°Ô∏è</span><span>Amanh√£</span><span class="dayDate" id="lblAgendaAmanha">‚Äî</span>
                </button>
              </div>

            </div>
          </div>
        </div>

        <div style="display:none">
          <span id="kpiAgenda">‚Äî</span>
          <span id="kpiBms">‚Äî</span>
          <span id="kpiProg">‚Äî</span>
        </div>
<div class="panel" style="margin-bottom:12px">
          <div class="controls" style="justify-content:space-between; align-items:center">
            <div class="controls" style="justify-content:flex-start">
              <div class="pill"><span>üìÖ De</span><input id="fFrom" type="date" style="min-width:140px"></div>
              <div class="pill"><span>At√©</span><input id="fTo" type="date" style="min-width:140px"></div>
              <div class="pill"><span>üîΩ</span>
                <select id="fQuick" style="border:0;outline:0;background:transparent;color:var(--text)">
                  <option value="7">Pr√≥ximos 7 dias</option>
                  <option value="today">Hoje</option>
                  <option value="all">Tudo</option>
                </select>
              </div>
            </div>
            <div class="controls">
              <span class="chip"><strong id="agendaCount">0</strong> itens</span>
              <button class="btn" id="btnApply">Aplicar</button>
            </div>
          </div>
          <div class="hr"></div>
          <div class="controls" style="justify-content:flex-start; gap:8px; flex-wrap:wrap">
            <label class="pill" style="cursor:pointer"><input type="checkbox" class="bucket" value="GBR_CLT" checked style="accent-color:var(--accent)"> GBR CLT</label>
            <label class="pill" style="cursor:pointer"><input type="checkbox" class="bucket" value="GBR" checked style="accent-color:var(--accent)"> GBR</label>
            <label class="pill" style="cursor:pointer"><input type="checkbox" class="bucket" value="3P_CLT" checked style="accent-color:var(--accent)"> 3P CLT</label>
            <label class="pill" style="cursor:pointer"><input type="checkbox" class="bucket" value="3P_PORT" checked style="accent-color:var(--accent)"> 3P PORT</label>
            <label class="pill" style="cursor:pointer"><input type="checkbox" class="bucket" value="M2_PORT" checked style="accent-color:var(--accent)"> M2 PORT</label>
            <label class="pill" style="cursor:pointer"><input type="checkbox" class="bucket" value="2A_PORT" checked style="accent-color:var(--accent)"> 2A PORT</label>
            <label class="pill" style="cursor:pointer"><input type="checkbox" class="bucket" value="VMC_PORT" checked style="accent-color:var(--accent)"> VMC PORT</label>
          </div>
        </div>
<div class="gridAgenda">
          <div class="panel agenda-prog">
            <h3>Programa√ß√£o (disparos por empresa)</h3>
            <div class="muted">Resumo por dia e por empresa. (Hoje/Amanh√£ + tabela r√°pida). Abra as datas para ver as linhas detalhadas.</div>
            <div id="agendaProgFocus" class="agenda-focus"></div>
            <div id="agendaProgResumo" class="agendaResumo"></div>
            <div class="hr"></div>
            <div id="agendaProg"></div>
          </div>
          <details class="panel bm-details" id="agendaBmsDetails">
            <summary>Agenda de BMs (opcional)</summary>
            <div style="margin-top:12px">
              <div class="muted" style="margin-bottom:10px">Controle paralelo (agendamento das BMs). Se n√£o usar, pode ignorar.</div>
              <div id="agendaBms"></div>
            </div>
          </details>
        </div>
</div>
      </div>

      
      <!-- ROD√çZIO DO DIA -->
      <div id="viewRodizio" style="display:none">
        <div class="panel" style="margin-bottom:16px">
          <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap">
            <div>
              <h3 style="margin:0">Rod√≠zio do dia</h3>
              <div class="muted" id="rodHint" style="margin-top:4px">Leitores enviam o rod√≠zio (Supervisor + Operadores). Apenas editores visualizam.</div>
            </div>
            <div class="controls">
              <button class="btn" id="rodRefresh" style="display:none">Recarregar</button>
            </div>
          </div>
        </div>

        <!-- Reader form -->
        <div class="panel" id="rodReaderBox" style="display:none">
          <h3 style="margin-top:0">Enviar rod√≠zio</h3>

          <div style="display:grid;grid-template-columns:220px 1fr;gap:12px;align-items:end;flex-wrap:wrap">
            <div class="field">
              <label>Data</label>
              <input class="cell" id="rodDate" type="date" />
            </div>
            <div class="field">
              <label>Supervisor</label>
              <input class="cell" id="rodSupervisor" placeholder="Ex: Supervisor X" />
            </div>
          </div>

          <div style="display:grid;grid-template-columns:240px 1fr;gap:12px;margin-top:12px">
            <div class="field">
              <label>Empresa / Produto</label>
              <select class="cell" id="rodEmpresa">
                <option value="">Selecione‚Ä¶</option>
                <option value="GBR_CLT">GBR CLT</option>
                <option value="GBR">GBR NOVO</option>
                <option value="3P_CLT">3P CLT</option>
                <option value="3P_PORT">3P PORT</option>
                <option value="M2_PORT">M2 PORT</option>
                <option value="2A_PORT">2A PORT</option>
                <option value="VMC_PORT">VMC PORT</option>
              </select>
            </div>
            <div class="field">
              <label>Operadores (um por linha)</label>
              <textarea class="cell" id="rodOperadores" placeholder="Operador 1&#10;Operador 2&#10;Operador 3"></textarea>
            </div>
          </div>

          <div class="field" style="margin-top:12px">
            <label>Observa√ß√£o (opcional)</label>
            <input class="cell" id="rodObs" placeholder="Ex: colocar no rod√≠zio apenas equipe manh√£" />
          </div>

          <div class="controls" style="margin-top:14px;justify-content:flex-start">
            <button class="btn primary" id="rodSend">Enviar para o Planejamento</button>
          </div>

          <div class="muted" style="margin-top:10px">
            Dica: escreva os operadores exatamente como est√£o no CRM (evita d√∫vida na triagem).
          </div>
        </div>

        <!-- Editor list -->
        <div class="panel" id="rodEditorBox" style="display:none">
          <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between">
            <div class="controls" style="justify-content:flex-start;gap:10px;flex-wrap:wrap">
              <div class="pill"><span>üìå</span>
                <select id="rodFilterEmpresa" style="border:0;outline:0;background:transparent;color:var(--text)">
                  <option value="ALL">Todas empresas</option>
                  <option value="GBR_CLT">GBR CLT</option>
                  <option value="GBR">GBR NOVO</option>
                  <option value="3P_CLT">3P CLT</option>
                  <option value="3P_PORT">3P PORT</option>
                  <option value="M2_PORT">M2 PORT</option>
                  <option value="2A_PORT">2A PORT</option>
                  <option value="VMC_PORT">VMC PORT</option>
                </select>
              </div>

              <div class="pill"><span>üìÖ</span>
                <input id="rodFilterDate" type="date" style="border:0;outline:0;background:transparent;color:var(--text)" />
              </div>

              <button class="btn" id="rodClearFilters">Limpar filtros</button>
            </div>

            <span class="chip"><strong id="rodCount">0</strong> rod√≠zios</span>
          </div>

          <div class="muted" id="rodDebug" style="margin-top:10px"></div>

          <div id="rodList" style="margin-top:14px;display:flex;flex-direction:column;gap:10px"></div>
        </div>
      </div>

<!-- PROGRAMA√á√ÉO -->
      <div id="viewProg" style="display:none">
        <div class="grid2">
          <div class="panel">
            <div class="controls" style="justify-content:space-between;margin-bottom:10px">
              <div class="controls" style="justify-content:flex-start">
                <div class="pill"><span>üìÖ</span><input id="progDate" type="date" style="min-width:140px" /></div>
                <div class="pill">
                  <span>üìå</span>
                  <select id="progBucket" style="border:0;outline:0;background:transparent;color:var(--text)">
                    <option value="GBR_CLT">GBR CLT</option>
                    <option value="GBR_NOVO">GBR NOVO</option>
                    <option value="3P_CLT">3P CLT</option>
                    <option value="3P_PORT">3P PORT</option>
                    <option value="M2_PORT">M2 PORT</option>
                    <option value="2A_PORT">2A PORT</option>
                    <option value="VMC_PORT">VMC PORT</option>
                  </select>
                </div>
                <button class="btn" id="btnAddLine" disabled>Ôºã Linha</button>
                <button class="btn" id="btnImport" disabled>Importar texto</button>
                <button class="btn" id="btnProgDeleteSelected" disabled title="Apaga as linhas selecionadas">üóëÔ∏è Apagar selecionados</button>
                <button class="btn" id="btnProgClearDay" disabled title="Remove toda a programa√ß√£o do dia/bucket atual">üßπ Limpar dia</button>
              </div>
              <div class="controls">
                <span class="chip" id="totals"><strong>0</strong> linhas ‚Ä¢ <strong>0</strong> disparos</span>
                <button class="btn primary" id="btnGenerate">Gerar texto</button>
                <button class="btn" id="btnCopy">Copiar</button>
              </div>
            </div>

            <div style="max-height:520px;overflow:auto;border-radius:14px">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width:44px">
                      <input type="checkbox" id="progSelectAll" aria-label="Selecionar tudo" />
                    </th>
                    <th style="width:180px">Operador</th>
                    <th style="width:140px">4 d√≠gitos</th>
                    <th style="width:110px">Qtd</th>
                    <th style="width:140px">Hora</th>
                    <th style="width:90px">A√ß√£o</th>
                  </tr>
                </thead>
                <tbody id="progBody"></tbody>
              </table>
            </div>
          </div>

          <div class="panel">
            <h3>Texto gerado</h3>
            <pre class="output" id="progOutput"></pre>
          </div>
        </div>
      </div>
    <!-- SUPORTES (somente editores) -->
    <div id="viewSupport" style="display:none">
      <div class="panel">
        <div class="controls" style="justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap">
          <div>
            <h3 style="margin:0">Suportes (Inbox)</h3>
            <div class="muted">Solicita√ß√µes enviadas pelos leitores via üí¨. Somente editores conseguem visualizar.</div>
          </div>
          <div class="controls">
            <button class="btn" id="supportRefresh">Recarregar</button>
          </div>
        </div>

        <div class="hr"></div>

        <div class="controls" style="justify-content:flex-start;gap:10px;flex-wrap:wrap">
          <div class="pill"><span>üè¢</span>
            <select id="supportEmpresa" style="border:0;outline:0;background:transparent;color:var(--text)">
              <option value="ALL">Todas</option>
              <option value="GBR_CLT">GBR CLT</option>
              <option value="GBR_NOVO">GBR NOVO</option>
              <option value="3P_CLT">3P CLT</option>
              <option value="3P_PORT">3P PORT</option>
              <option value="M2_PORT">M2 PORT</option>
              <option value="2A_PORT">2A PORT</option>
              <option value="VMC_PORT">VMC PORT</option>
            </select>
          </div>

          <div class="pill"><span>‚úÖ</span>
            <select id="supportStatus" style="border:0;outline:0;background:transparent;color:var(--text)">
              <option value="OPEN">Abertos</option>
              <option value="ALL">Todos</option>
              <option value="DONE">Resolvidos</option>
            </select>
          </div>


          <div class="pill"><span>üë§</span>
            <select id="supportResp" style="border:0;outline:0;background:transparent;color:var(--text)">
              <option value="ALL">Todos respons√°veis</option>
              <option value="UNASSIGNED">Sem respons√°vel</option>
            </select>
          </div>

          <button class="btn" id="supportConfigBtn" style="display:none">Configurar respons√°veis</button>

          <span class="chip"><strong id="supportCount">0</strong> itens</span>
          <span class="muted" id="supportDebug">‚Äî</span>
        </div>

        <div class="hr"></div>

        <div id="supportList" style="display:flex;flex-direction:column;gap:10px;max-height:70vh;overflow:auto;padding-right:2px"></div>
        <div class="muted" style="margin-top:10px">Dica: teste direto no navegador: <code>?action=inbox_list&token=...</code> e confira se h√° itens. Se o total for &gt; 0 e aqui n√£o aparecer, √© cache do GitHub.</div>
      </div>
    </div>

  
    </div>
  </div>
</div>

<!-- BM Modal -->
  <div class="backdrop" id="bmBackdrop">
    <div class="modal">
      <div class="modal-header">
        <b id="bmTitle">BM</b>
        <button class="btn" id="bmClose">‚úï</button>
      </div>

      <div class="modal-body">
        <div style="display:flex;flex-direction:column;gap:12px">
          <div class="field">
            <label>Identifica√ß√£o da BM</label>
            <input class="cell" id="fBmId" placeholder="Ex: GBR NOVO - 7436" />
          </div>

          <div class="field">
            <label>Empresa / Produto</label>
            <select class="cell" id="fEmpresa">
              <option value="">Selecione‚Ä¶</option>
              <option value="GBR_CLT">GBR CLT</option>
              <option value="GBR_NOVO">GBR NOVO</option>
              <option value="3P_CLT">3P CLT</option>
              <option value="3P_PORT">3P PORT</option>
              <option value="M2_PORT">M2 PORT</option>
              <option value="2A_PORT">2A PORT</option>
              <option value="VMC_PORT">VMC PORT</option>
            </select>
          </div>

          <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
            <div class="field">
              <label>Status</label>
              <select class="cell" id="fColumn">
                <option value="standby">STAND BY</option>
                <option value="numeros">N√öMEROS</option>
                <option value="cartao">CART√ÉO</option>
                <option value="template">TEMPLATE</option>
                <option value="disparos">DISPAROS</option>
              </select>
            </div>

            <div class="field">
              <label>Qualidade</label>
              <select class="cell" id="fQuality">
                <option value="APROVADO">Aprovado</option>
                <option value="MEDIA">Qualidade m√©dia</option>
                <option value="BAIXA">Qualidade baixa (risco)</option>
              </select>
            </div>
          </div>

          <details id="bmMore" class="bm-details">
            <summary>Detalhes (n√∫meros, agendamento, observa√ß√µes)</summary>
            <div style="display:flex;flex-direction:column;gap:12px;margin-top:12px">

              <div class="field" id="bmNumbersWrap">
                <label>N√∫meros (at√© 10) ‚Äî um por linha</label>
                <textarea class="cell" id="fNumbers" placeholder="11999999999&#10;11888888888"></textarea>
                <div class="muted">Contagem: <span class="mono" id="fNumbersCount">0/10</span></div>
              </div>

              <div class="field" id="bmScheduleWrap">
                <label>Agendamento (data)</label>
                <input class="cell" id="fDisparoDate" type="date" />
                <div class="muted" style="margin-top:6px">ou selecione um dia da semana</div>
                <select class="cell" id="fDisparoWeekday" style="margin-top:6px">
                  <option value="">‚Äî</option>
                  <option value="SEGUNDA">Segunda</option>
                  <option value="TERCA">Ter√ßa</option>
                  <option value="QUARTA">Quarta</option>
                  <option value="QUINTA">Quinta</option>
                  <option value="SEXTA">Sexta</option>
                  <option value="SABADO">S√°bado</option>
                  <option value="DOMINGO">Domingo</option>
                </select>
              </div>

              <div class="field">
                <label>Observa√ß√µes</label>
                <textarea class="cell" id="fNotes"></textarea>
              </div>

              <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
                <div class="field">
                  <label>Criada em</label>
                  <input class="cell" id="fCreatedAt" disabled />
                </div>
                <div class="field">
                  <label>√öltima edi√ß√£o</label>
                  <input class="cell" id="fUpdatedAt" disabled />
                </div>
              </div>

              <div class="field">
                <label>A√ß√µes</label>
                <div class="controls" style="justify-content:flex-start">
                  <button class="btn danger" id="bmDelete">Excluir</button>
                </div>
                <div class="muted">Edi√ß√£o s√≥ no link com <span class="mono">#edit=1&key=...</span></div>
              </div>
            </div>
          </details>

        </div>
      </div>

      <div class="modal-footer">
        <div class="muted" id="bmMode">Leitura</div>
        <div class="controls">
          <button class="btn" id="bmCancel">Cancelar</button>
          <button class="btn primary" id="bmSave">Salvar</button>
        </div>
      </div>
    </div>
  </div>

<!-- Import Modal -->
  <div class="backdrop" id="importBackdrop">
    <div class="modal" style="width:min(780px,100%)">
      <div class="modal-header">
        <b>Importar texto</b>
        <button class="btn" id="importClose">‚úï</button>
      </div>
      <div class="modal-body" style="grid-template-columns:1fr">
        <div class="field">
          <label>Cole o texto (MARCOS / 5768 - 100 (09:30))</label>
          <textarea class="cell" id="importText" style="min-height:260px"></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <div class="muted">Cria linhas na data + carteira selecionadas.</div>
        <div class="controls">
          <button class="btn" id="importCancel">Cancelar</button>
          <button class="btn primary" id="importRun">Importar</button>
        </div>
      </div>
    </div>
  </div>

  
  <!-- Suporte (leitores enviam; editores tratam na aba Suportes) -->
  <div class="support-fab" id="supportFab" title="Suporte / Sugest√µes"><span>üí¨</span></div>

  <div class="backdrop" id="supportBackdrop">
    <div class="modal" style="width:min(860px,100%)">
      <div class="modal-header">
        <b>Suporte / Sugest√µes</b>
        <button class="btn" id="supportClose">‚úï</button>
      </div>
      <div class="modal-body">
        <div class="field">
          <label>Seu nome / cargo (ex: Supervisor X)</label>
          <input class="cell" id="supSender" placeholder="Ex: Supervisor X" />
        </div>
        <div class="field">
          <label>Empresa / Produto</label>
          <select class="cell" id="supEmpresa">
            <option value="GBR_CLT">GBR CLT</option>
            <option value="GBR_NOVO">GBR NOVO</option>
            <option value="3P_CLT">3P CLT</option>
            <option value="3P_PORT">3P PORT</option>
            <option value="M2_PORT">M2 PORT</option>
            <option value="2A_PORT">2A PORT</option>
            <option value="VMC_PORT">VMC PORT</option>
          </select>
        </div>
        <div class="field">
          <label>Tipo</label>
          <select class="cell" id="supTipo">
            <option value="PEDIDO">Pedido</option>
            <option value="SUGESTAO">Sugest√£o</option>
            <option value="ALERTA">Alerta</option>
          </select>
        </div>
        <div class="field">
          <label>Mensagem</label>
          <textarea class="cell" id="supMsg" placeholder="Descreva o que precisa..." style="min-height:140px"></textarea>
        </div>
        <div class="field">
          <label>Lista de operadores (opcional) ‚Äî um por linha</label>
          <textarea class="cell" id="supOps" placeholder="OPERADOR 1&#10;OPERADOR 2" style="min-height:120px"></textarea>
        </div>
        <div class="controls" style="justify-content:flex-start">
          <button class="btn primary" id="supSend">Enviar</button>
          <button class="btn" id="supClear">Limpar</button>
          <span class="muted" id="supResult">‚Äî</span>
        </div>
        <div class="muted">O que voc√™ enviar aqui <b>n√£o aparece para outros leitores</b>. S√≥ editores veem na aba <b>Suportes</b>.</div>
      </div>
      <div class="modal-footer">
        <div class="controls">
          <button class="btn" id="supportOk">Fechar</button>
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <!-- LOGIN (roles: leitor/editor/supervisor) -->
  <div class="backdrop" id="loginBackdrop" style="display:none; z-index:9999">
    <div class="modal" style="width:min(460px,100%)">
      <div class="modal-header">
        <b>Acesso</b>
      </div>
      <div class="modal-body">
        <div class="field">
          <label>Usu√°rio</label>
          <input class="cell" id="loginUser" placeholder="Ex: leitor01" autocomplete="username" />
        </div>
        <div class="field">
          <label>Senha</label>
          <input class="cell" id="loginPass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password" />
        </div>
        <div class="controls" style="justify-content:flex-start">
          <label class="muted" style="display:flex; align-items:center; gap:8px; user-select:none">
            <input type="checkbox" id="loginRemember" /> Manter conectado neste PC
          </label>
        </div>
        <div class="controls" style="justify-content:flex-start">
          <button class="btn primary" id="loginBtn">Entrar</button>
          <span class="muted" id="loginMsg">‚Äî</span>
        </div>
        <div class="muted" style="margin-top:10px">Este acesso controla permiss√µes de <b>Leitor</b>, <b>Editor</b> e <b>Supervisor</b>.
        </div>
      </div>
    </div>
  </div>

  <script>
    // FIXO: todos carregam do mesmo /exec
    const API_URL = "https://script.google.com/macros/s/AKfycbxyWYuCvc5P-LL3LzKOKiyJ6DeQEijd3R23fyIgQ-Q87wf4sylrF4z5sWhfJ6qYCfKH/exec";

    const COLUMNS = [
      { id:"standby",  name:"STAND BY" },
      { id:"numeros",  name:"N√öMEROS" },
      { id:"cartao",   name:"CART√ÉO" },
      { id:"template", name:"TEMPLATE" },
      { id:"disparos", name:"DISPAROS" }
    ];
    const BUCKETS = [
      {id:"GBR_CLT",label:"GBR CLT"},
      {id:"GBR",label:"GBR"},
      {id:"3P_CLT",label:"3P CLT"},
      {id:"3P_PORT",label:"3P PORT"},
      {id:"M2_PORT",label:"M2 PORT"},
      {id:"2A_PORT",label:"2A PORT"},
      {id:"VMC_PORT",label:"VMC PORT"}
    ];

    function normalizeBucket(raw){
      const b = String(raw||"").trim().toUpperCase();
      if(b === "GBR_NOVO") return "GBR";
      if(b === "3P_CLT") return "3P_CLT";
      if(b === "3PORT") return "3P_PORT";
      if(b === "3P PORT") return "3P_PORT";
      if(b === "3P_PORT") return "3P_PORT";
      if(b === "GBR_CLT") return "GBR_CLT";
      if(b === "GBR") return "GBR";
      if(b === "3P") return "3P_CLT";
      if(b === "M2" || b === "M2 PORT" || b === "M2_PORT") return "M2_PORT";
      if(b === "2A" || b === "2A PORT" || b === "2A_PORT") return "2A_PORT";
      if(b === "VMC" || b === "VMC PORT" || b === "VMC_PORT") return "VMC_PORT";
      if(b === "M2_PORT") return "M2_PORT";
      if(b === "2A_PORT") return "2A_PORT";
      if(b === "VMC_PORT") return "VMC_PORT";
      return "GBR";
    }

    function bucketProduct(bucket){
      const b = String(bucket||"").toUpperCase();
      if(b.endsWith("_CLT")) return "CLT";
      if(b.endsWith("_PORT")) return "PORT";
      if(b === "GBR") return "NOVO";
      if(b.endsWith("_NOVO")) return "NOVO";
      return "OUTRO";
    }

    function getSelectedBuckets(){
      const checks = Array.from(document.querySelectorAll("input.bucket"));
      const selected = checks.filter(c=>c.checked).map(c=>c.value);
      return new Set(selected);
    }

    function addDays(iso, days){
      const [y,m,d] = iso.split("-").map(Number);
      const dt = new Date(y, m-1, d);
      dt.setDate(dt.getDate()+days);
      return `${dt.getFullYear()}-${pad2(dt.getMonth()+1)}-${pad2(dt.getDate())}`;
    }

    function inDateRange(dateIso){
      const from = $("#fFrom")?.value || "";
      const to = $("#fTo")?.value || "";
      if(from && dateIso < from) return false;
      if(to && dateIso > to) return false;
      return true;
    }

    function applyQuickRange(){
      const q = $("#fQuick").value;
      const today = todayISO();
      const tomorrow = addDays(today, 1);
      if(q === "today"){
        $("#fFrom").value = today;
        $("#fTo").value = today;
      } else if(q === "tomorrow"){
        $("#fFrom").value = tomorrow;
        $("#fTo").value = tomorrow;
      } else if(q === "7"){
        $("#fFrom").value = today;
        $("#fTo").value = addDays(today, 7);
      } else {
        $("#fFrom").value = "";
        $("#fTo").value = "";
      }
      renderAgendaProg();
      renderAgendaBms();
      try{ updateAgendaDayFocus(); }catch(_){}
    }

    function updateHeroSummary(){
      const elAgenda = document.getElementById('kpiAgenda');
      const elBms = document.getElementById('kpiBms');
      const elProg = document.getElementById('kpiProg');
      const elHoje = document.getElementById('kpiHoje');

      if(elAgenda){
        const c = document.getElementById('agendaCount');
        elAgenda.textContent = (c && c.textContent) ? c.textContent : String((state && state.dispatches ? state.dispatches.length : 0));
      }
      if(elBms){
        elBms.textContent = String((state && state.items ? state.items.length : 0));
      }
      if(elProg){
        elProg.textContent = String((state && state.dispatches ? state.dispatches.length : 0));
      }
      if(elHoje){
        const today = todayISO();
        let sum = 0;
        const list = Array.isArray(state?.dispatches) ? state.dispatches : [];
        for(const d of list){
          if(String(d?.date||'') !== today) continue;
          const q = Number(d?.qty ?? d?.qtd ?? d?.count ?? 0);
          if(!isNaN(q)) sum += q;
        }
        elHoje.textContent = String(sum);
      }
    }


    const bucketLabel = (id)=> (BUCKETS.find(b=>b.id===id)?.label || id);

    let state = { items: [], dispatches: [], metas: {} };
    let auth = { token:"", role:"", user:"" };
    const AUTH_STORE = "exec:auth";
    let syncing=false, dirty=false, lastSig="";
    let saveTimer=null;

    // --- Rede/Salvamento (robusto) ---
    let changeRev=0;
    let savedRev=0;
    let saveInFlight=false;
    let pendingSave=false;
    // Programa√ß√£o: sele√ß√£o em massa
    let progSelKey="";
    const progSel = new Set();

    const DRAFT_LS_PREFIX = "execDraft:";
    const draftKey = ()=> (DRAFT_LS_PREFIX + "user:" + (auth.user||"anon"));

    function safeClone(obj){
      try{
        if(typeof structuredClone === "function") return structuredClone(obj);
      }catch(e){}
      return JSON.parse(JSON.stringify(obj));
    }

    function persistDraft(){
      if(!canEdit()) return;
      // grava somente o necess√°rio (menor JSON = menos travada)
      try{
        const minimal = stripForSave(state);
        localStorage.setItem(draftKey(), JSON.stringify({ ts: Date.now(), state: minimal }));
      }catch(e){}
    }

    function readDraft(){
      if(!canEdit()) return null;
      try{
        const raw = localStorage.getItem(draftKey());
        if(!raw) return null;
        const d = JSON.parse(raw);
        if(!d || !d.state) return null;
        // Se o rascunho local for muito antigo, descarta para evitar travar a sincroniza√ß√£o
        try{ if(d.ts && (Date.now() - Number(d.ts)) > 6*60*60*1000){ clearDraft(); return null; } }catch(_){ }
        // normaliza campos esperados
        if(!Array.isArray(d.state.items)) d.state.items = [];
        if(!Array.isArray(d.state.dispatches)) d.state.dispatches = [];
        if(!d.state.metas) d.state.metas = {};
        return d;
      }catch(e){ return null; }
    }

    function clearDraft(){
      if(!canEdit()) return;
      try{ localStorage.removeItem(draftKey()); }catch(e){}
    }

    // --- Cache local ultra-r√°pido (IndexedDB) ---
    const CACHE_DB = 'execCacheDB';
    const CACHE_STORE = 'states';
    let __idb = null;

    function cacheKeyOnline(){
      // cache por chave de edi√ß√£o (se existir), para separar ambientes
      return 'online:shared';
    }

    function _idbOpen(){
      return new Promise((resolve, reject)=>{
        if(!('indexedDB' in window)) return reject(new Error('indexedDB indispon√≠vel'));
        const req = indexedDB.open(CACHE_DB, 1);
        req.onupgradeneeded = ()=>{
          const db = req.result;
          if(!db.objectStoreNames.contains(CACHE_STORE)) db.createObjectStore(CACHE_STORE);
        };
        req.onsuccess = ()=> resolve(req.result);
        req.onerror = ()=> reject(req.error || new Error('Falha ao abrir IndexedDB'));
      });
    }

    async function idb(){
      if(__idb) return __idb;
      __idb = await _idbOpen();
      return __idb;
    }

    async function cacheGet(k){
      // IndexedDB (preferido)
      try{
        const db = await idb();
        return await new Promise((resolve, reject)=>{
          const tx = db.transaction(CACHE_STORE, 'readonly');
          const st = tx.objectStore(CACHE_STORE);
          const r = st.get(k);
          r.onsuccess = ()=> resolve(r.result || null);
          r.onerror = ()=> reject(r.error);
        });
      }catch(e){
        // Fallback: localStorage (pode ser limitado)
        try{
          const raw = localStorage.getItem('execCache:' + k);
          return raw ? JSON.parse(raw) : null;
        }catch(_){
          return null;
        }
      }
    }

    async function cacheSet(k, v){
      try{
        const db = await idb();
        await new Promise((resolve, reject)=>{
          const tx = db.transaction(CACHE_STORE, 'readwrite');
          tx.objectStore(CACHE_STORE).put(v, k);
          tx.oncomplete = ()=> resolve();
          tx.onerror = ()=> reject(tx.error);
          tx.onabort = ()=> reject(tx.error);
        });
      }catch(e){
        try{
          localStorage.setItem('execCache:' + k, JSON.stringify(v));
        }catch(_){ }
      }
    }

    function cacheSetSoon(){
      // grava cache em idle e longe de intera√ß√£o do usu√°rio (evita "tique")
      const key = cacheKeyOnline();
      const payload = { ts: Date.now(), state: stripForSave(state), sig: lastSig || '' };

      const doWrite = ()=> cacheSet(key, payload).catch(()=>{});

      const since = Date.now() - (window.__lastUI || 0);
      if(since < 1200){
        clearTimeout(window.__cacheDelay);
        window.__cacheDelay = setTimeout(()=>{
          if('requestIdleCallback' in window) requestIdleCallback(doWrite, { timeout: 2000 });
          else setTimeout(doWrite, 0);
        }, 1200);
        return;
      }

      if('requestIdleCallback' in window) requestIdleCallback(doWrite, { timeout: 2000 });
      else setTimeout(doWrite, 0);
    }

    // --- Performance helpers ---
    function debounce(fn, wait){
      let t=null;
      return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), wait); };
    }

    // Evita travar a UI salvando rascunho a cada clique (JSON grande no localStorage)
    let draftTimer = null;
    function persistDraftSoon(){
      if(!canEdit()) return;
      clearTimeout(draftTimer);
      // espera o usu√°rio parar de clicar/digitar e grava em idle
      draftTimer = setTimeout(()=>{
        const doWrite = ()=>{ try{ persistDraft(); }catch(_){} };
        const since = Date.now() - (window.__lastUI || 0);
        if(since < 1200){
          clearTimeout(window.__draftDelay);
          window.__draftDelay = setTimeout(()=>{
            if('requestIdleCallback' in window) requestIdleCallback(doWrite, { timeout: 2500 });
            else setTimeout(doWrite, 0);
          }, 1200);
          return;
        }
        if('requestIdleCallback' in window) requestIdleCallback(doWrite, { timeout: 2500 });
        else setTimeout(doWrite, 0);
      }, 900);
    }


    const $ = (s)=>document.querySelector(s);
    // Marca a √∫ltima intera√ß√£o do usu√°rio (evita tarefas em idle causarem "tique")
    window.__lastUI = Date.now();
    (function(){
      const evs = ['pointerdown','keydown','wheel','touchstart'];
      for(const ev of evs){
        window.addEventListener(ev, ()=>{ window.__lastUI = Date.now(); }, { passive:true, capture:true });
      }
    })();

    const toast = (m)=>{ const t=$("#toast"); t.textContent=m; t.classList.add("show"); clearTimeout(window.__tt); window.__tt=setTimeout(()=>t.classList.remove("show"), 2600); };
    const pad2=(n)=>String(n).padStart(2,"0");
    const todayISO=()=>{ const d=new Date(); return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`; };
    const nowISO=()=>{ const d=new Date(); return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())} ${pad2(d.getHours())}:${pad2(d.getMinutes())}`; };
    const toBR=(iso)=>{ if(!iso) return "‚Äî"; const [y,m,d]=iso.split("-"); return `${d}/${m}/${y}`; };
    const uid=()=> (crypto?.randomUUID?.() || ("id-"+Math.random().toString(16).slice(2)+"-"+Date.now()));
    const escapeHtml=(s)=>String(s||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll("\"","&quot;").replaceAll("'","&#039;");

    async function copyToClipboard(text){
      const t = String(text ?? "").trim();
      if(!t){ toast("Nada para copiar"); return false; }
      try{
        // Clipboard API only works in secure contexts (HTTPS/localhost)
        if(navigator.clipboard && window.isSecureContext){
          await navigator.clipboard.writeText(t);
          toast("Resumo copiado ‚úÖ");
          return true;
        }
        throw new Error("Clipboard API indispon√≠vel");
      }catch(e){
        // Fallback (execCommand)
        try{
          const ta = document.createElement("textarea");
          ta.value = t;
          ta.setAttribute("readonly", "");
          ta.style.position = "fixed";
          ta.style.left = "-9999px";
          ta.style.top = "0";
          ta.style.opacity = "0";
          document.body.appendChild(ta);
          ta.focus({preventScroll:true});
          ta.select();
          ta.setSelectionRange(0, ta.value.length);
          let ok = false;
          try{ ok = document.execCommand("copy"); }catch(err){ ok = false; }
          document.body.removeChild(ta);
          toast(ok ? "Resumo copiado ‚úÖ" : "N√£o foi poss√≠vel copiar");
          return ok;
        }catch(err){
          toast("N√£o foi poss√≠vel copiar");
          return false;
        }
      }
    }

    // Dashboard: tiny canvas trend + drilldown modal (com tooltip)
    const drawTrendCanvas = (canvas, labels, series) => {
      if(!canvas) return;
      const ctx = canvas.getContext('2d');
      if(!ctx) return;

      // cache p/ interatividade
      canvas.__trendData = { labels: labels || [], series: series || [] };

      const dpr = window.devicePixelRatio || 1;
      const w = Math.max(260, canvas.clientWidth || canvas.parentElement?.clientWidth || 600);
      const h0 = Number(canvas.getAttribute('height') || 120);

      canvas.width = Math.floor(w * dpr);
      canvas.height = Math.floor(h0 * dpr);
      canvas.style.width = w + 'px';
      canvas.style.height = h0 + 'px';
      ctx.setTransform(dpr,0,0,dpr,0,0);

      ctx.clearRect(0,0,w,h0);

      if(!labels || labels.length===0 || !series || series.length===0){
        ctx.globalAlpha = 0.75;
        ctx.fillStyle = 'rgba(255,255,255,.75)';
        ctx.font = '12px system-ui, -apple-system, Segoe UI, Roboto, Arial';
        ctx.fillText('Sem dados no per√≠odo.', 12, 18);
        ctx.globalAlpha = 1;
        canvas.__trendMeta = null;
        return;
      }

      let maxV = 0;
      for(const s of series){
        for(const v of (s.values||[])) maxV = Math.max(maxV, Number(v||0));
      }
      maxV = Math.max(1, maxV);

      const padL = 36, padR = 10, padT = 10, padB = 22;
      const iw = w - padL - padR;
      const ih = h0 - padT - padB;

      const n = labels.length;
      const xAt = (i)=> padL + (n===1 ? 0 : (iw * i/(n-1)));
      const yAt = (v)=> padT + ih - (ih * (Number(v||0)/maxV));

      // meta (p/ hover/click)
      canvas.__trendMeta = { w, h0, padL, padR, padT, padB, iw, ih, maxV, labels, series, xAt, yAt };

      // grid
      ctx.globalAlpha = 0.22;
      ctx.strokeStyle = 'rgba(255,255,255,.35)';
      ctx.lineWidth = 1;
      for(let k=0;k<=4;k++){
        const y = padT + (ih*k/4);
        ctx.beginPath();
        ctx.moveTo(padL, y);
        ctx.lineTo(padL+iw, y);
        ctx.stroke();
      }
      ctx.globalAlpha = 1;

      // y labels
      ctx.fillStyle = 'rgba(255,255,255,.75)';
      ctx.font = '12px system-ui, -apple-system, Segoe UI, Roboto, Arial';
      ctx.fillText(String(maxV), 6, padT+12);
      ctx.fillText('0', 10, padT+ih);

      // lines + points
      series.forEach((s, idx)=>{
        const hue = (idx*70) % 360;
        const stroke = `hsl(${hue} 90% 70%)`;
        ctx.strokeStyle = stroke;
        ctx.lineWidth = 2;
        ctx.beginPath();
        (s.values||[]).forEach((v,i)=>{
          const x = xAt(i), y = yAt(v);
          if(i===0) ctx.moveTo(x,y);
          else ctx.lineTo(x,y);
        });
        ctx.stroke();

        ctx.fillStyle = stroke;
        (s.values||[]).forEach((v,i)=>{
          const x=xAt(i), y=yAt(v);
          ctx.beginPath();
          ctx.arc(x,y,2.2,0,Math.PI*2);
          ctx.fill();
        });
      });

      // x labels (first/last)
      ctx.fillStyle = 'rgba(255,255,255,.7)';
      const first = labels[0], last = labels[labels.length-1];
      ctx.fillText(toBR(first), padL, h0-6);
      const tw = ctx.measureText(toBR(last)).width;
      ctx.fillText(toBR(last), padL+iw-tw, h0-6);

      // --- Interatividade (tooltip + clique) ---
      if(!canvas.__trendInit){
        canvas.__trendInit = true;

        const parent = canvas.parentElement || document.body;
        try{
          const cs = window.getComputedStyle(parent);
          if(cs && cs.position === 'static') parent.style.position = 'relative';
        }catch(e){}

        const tip = document.createElement('div');
        tip.className = 'trendTooltip';
        tip.setAttribute('aria-hidden','true');
        parent.appendChild(tip);
        canvas.__trendTip = tip;

        let raf = 0;
        const schedule = (fn)=>{
          if(raf) cancelAnimationFrame(raf);
          raf = requestAnimationFrame(fn);
        };

        const hideTip = ()=>{
          if(canvas.__trendTip) canvas.__trendTip.style.display = 'none';
          const m = canvas.__trendMeta;
          if(m) schedule(()=> drawTrendCanvas(canvas, m.labels, m.series));
        };

        const pickIndex = (clientX, clientY)=>{
          const m = canvas.__trendMeta;
          if(!m || !m.labels || !m.labels.length) return -1;
          const rect = canvas.getBoundingClientRect();
          const x = clientX - rect.left;
          const y = clientY - rect.top;
          if(x < (m.padL-12) || x > (m.padL+m.iw+12) || y < 0 || y > m.h0) return -1;
          const n = m.labels.length;
          if(n <= 1) return 0;
          const t = (x - m.padL) / m.iw;
          const idx = Math.max(0, Math.min(n-1, Math.round(t * (n-1))));
          const xi = m.xAt(idx);
          if(Math.abs(x - xi) > 14) return -1;
          return idx;
        };

        const showAt = (idx, clientX, clientY)=>{
          const m = canvas.__trendMeta;
          if(!m || idx < 0) return hideTip();

          const day = String(m.labels[idx]||'');
          const rows = (m.series||[]).map(s=>{
            const v = Number((s.values||[])[idx] || 0);
            return `<div class=\"ttRow\"><span>${escapeHtml(s.name||'‚Äî')}</span><b>${v}</b></div>`;
          }).join('');

          if(canvas.__trendTip){
            canvas.__trendTip.innerHTML = `<div class=\"ttTitle\">${escapeHtml(toBR(day))}</div>${rows}<div class=\"ttHint\">Passe o mouse para ver valores ‚Ä¢ Clique para selecionar o dia</div>`;
            canvas.__trendTip.style.display = 'block';

            const pr = parent.getBoundingClientRect();
            const left0 = (clientX - pr.left) + 12;
            const top0  = (clientY - pr.top) + 12;

            // clamp dentro do painel
            const maxLeft = (parent.clientWidth || 0) - canvas.__trendTip.offsetWidth - 8;
            const maxTop  = (parent.clientHeight || 0) - canvas.__trendTip.offsetHeight - 8;
            const left = Math.max(8, Math.min(left0, isFinite(maxLeft) ? maxLeft : left0));
            const top  = Math.max(8, Math.min(top0,  isFinite(maxTop) ? maxTop : top0));

            canvas.__trendTip.style.left = left + 'px';
            canvas.__trendTip.style.top  = top + 'px';
          }

          // highlight (re-draw + linha vertical + pontos)
          schedule(()=>{
            drawTrendCanvas(canvas, m.labels, m.series);
            const mm = canvas.__trendMeta;
            if(!mm) return;
            const c = canvas.getContext('2d');
            const xi = mm.xAt(idx);

            c.save();
            c.globalAlpha = 0.35;
            c.strokeStyle = 'rgba(255,255,255,.75)';
            c.lineWidth = 1;
            c.beginPath();
            c.moveTo(xi, mm.padT);
            c.lineTo(xi, mm.padT + mm.ih);
            c.stroke();
            c.globalAlpha = 1;

            (mm.series||[]).forEach((s, sidx)=>{
              const v = Number((s.values||[])[idx] || 0);
              const y = mm.yAt(v);
              const hue = (sidx*70) % 360;
              const stroke = `hsl(${hue} 90% 70%)`;
              c.fillStyle = stroke;
              c.beginPath();
              c.arc(xi, y, 4.3, 0, Math.PI*2);
              c.fill();
              c.strokeStyle = 'rgba(0,0,0,.35)';
              c.lineWidth = 2;
              c.stroke();
            });

            c.restore();
          });
        };

        canvas.addEventListener('pointerleave', hideTip);
        canvas.addEventListener('pointermove', (e)=>{
          const idx = pickIndex(e.clientX, e.clientY);
          if(idx < 0) return hideTip();
          showAt(idx, e.clientX, e.clientY);
        });

        canvas.addEventListener('pointerdown', (e)=>{
          const idx = pickIndex(e.clientX, e.clientY);
          if(idx < 0) return;
          const m = canvas.__trendMeta;
          if(!m) return;
          const day = String(m.labels[idx]||'');
          const daySel = document.getElementById('dashDay');
          if(daySel && day){
            daySel.value = day;
            try{ renderDashboard(); }catch(err){}
            try{ daySel.scrollIntoView({behavior:'smooth', block:'center'}); }catch(err){}
          }
        });
      }
    };

    const openDashDetail = (day, bucket) => {
      const backdrop = document.getElementById("dashDetailBackdrop");
      const title = document.getElementById("dashDetailTitle");
      const sub = document.getElementById("dashDetailSub");
      const tbody = document.querySelector("#dashDetailTable tbody");
      const totalEl = document.getElementById("dashDetailTotal");
      const numsEl = document.getElementById("dashDetailNums");
      const winEl = document.getElementById("dashDetailWin");
      const hint = document.getElementById("dashDetailHint");
      const closeBtn = document.getElementById("dashDetailClose");

      if(!backdrop || !tbody) return;

      const close = () => {
        backdrop.style.display = "none";
        backdrop.classList.remove("open");
      };

      // Ensure close always works (even if init missed)
      if(closeBtn) closeBtn.onclick = close;
      backdrop.onclick = (e)=>{ if(e.target === backdrop) close(); };
      document.onkeydown = (e)=>{ if(e.key === "Escape") close(); };

      const list = listDispatches(day, bucket).slice().sort((a,b)=> String(a.time||"").localeCompare(String(b.time||"")));
      const bucketId = normalizeBucket(bucket);

      if(title) title.textContent = `Detalhes ‚Ä¢ ${bucketLabel(bucketId)}`;
      if(sub) sub.textContent = `Dia ${toBR(String(day).slice(0,10))} ‚Ä¢ ${list.length} linhas`;      tbody.innerHTML = "";

      const toggleBtn = document.getElementById("dashDetailToggle");
      const LIMIT = 12;

      if(list.length === 0){
        tbody.innerHTML = `<tr><td colspan="3" class="muted">Sem linhas encontradas para este dia/empresa.</td></tr>`;
        if(totalEl) totalEl.textContent = "‚Äî";
        if(numsEl) numsEl.textContent = "‚Äî";
        if(winEl) winEl.textContent = "‚Äî";
        if(hint) hint.textContent = "Dica: confira se a programa√ß√£o foi salva no bucket correto e depois clique em Atualizar no Dashboard.";
        if(toggleBtn){ toggleBtn.style.display = "none"; toggleBtn.onclick = null; }
      }else{
        // KPIs calculados no conjunto completo (mesmo quando a lista est√° resumida)
        let total = 0;
        const nums = new Set();
        let minT = "", maxT = "";

        for(const r of list){
          total += Number(r.qty||0) || 0;
          const last4 = (r.last4 || "").toString();
          if(last4) nums.add(last4);
          if(r.time){
            if(!minT || r.time < minT) minT = r.time;
            if(!maxT || r.time > maxT) maxT = r.time;
          }
        }

        if(totalEl) totalEl.textContent = String(total);
        if(numsEl) numsEl.textContent = String(nums.size);
        if(winEl) winEl.textContent = (minT && maxT) ? `${minT}‚Äì${maxT}` : "‚Äî";

        let expanded = false;
        const renderRows = () => {
          tbody.innerHTML = "";
          const slice = expanded ? list : list.slice(0, LIMIT);
          for(const r of slice){
            const tr = document.createElement("tr");
            tr.innerHTML = `<td class="mono">${escapeHtml(r.time||"‚Äî")}</td><td class="mono">${escapeHtml((r.last4||"").toString()||"‚Äî")}</td><td><b>${Number(r.qty||0)||0}</b></td>`;
            tbody.appendChild(tr);
          }
        };

        // button expand/collapse
        if(toggleBtn && list.length > LIMIT){
          toggleBtn.style.display = "inline-flex";
          const updateBtn = () => {
            toggleBtn.textContent = expanded ? "Ver menos" : `Ver mais (${list.length - LIMIT})`;
          };
          toggleBtn.onclick = () => {
            expanded = !expanded;
            renderRows();
            updateBtn();
          };
          updateBtn();
        }else if(toggleBtn){
          toggleBtn.style.display = "none";
          toggleBtn.onclick = null;
        }

        renderRows();
        if(hint) hint.textContent = list.length > LIMIT ? `Mostrando ${Math.min(LIMIT, list.length)} de ${list.length} linhas. Use ‚ÄúVer mais‚Äù para expandir.` : "Voc√™ pode fechar clicando em 'Fechar', clicando fora do modal, ou pressionando ESC.";
      }

      backdrop.style.display = "grid";
      backdrop.classList.add("open");
    };

    // ---------- Autentica√ß√£o (Login + Roles) ----------
    const ROLE_ORDER = { reader: 1, editor: 2, supervisor: 3 };

    function canRead(){ return !!(auth && auth.token); }
    function canEdit(){ return auth.role === 'editor' || auth.role === 'supervisor'; }
    function isSupervisor(){ return auth.role === 'supervisor'; }

    function authLoad(){
      try{
        const raw = (sessionStorage.getItem(AUTH_STORE) || localStorage.getItem(AUTH_STORE) || '').trim();
        if(!raw) return;
        const j = JSON.parse(raw);
        if(j && j.token && j.role && j.user){
          auth = { token: String(j.token), role: String(j.role), user: String(j.user) };
        }
      }catch(_){ }
    }

    function authSave(persist){
      try{
        const raw = JSON.stringify(auth);
        sessionStorage.setItem(AUTH_STORE, raw);
        if(persist) localStorage.setItem(AUTH_STORE, raw);
      }catch(_){ }
    }

    function authClear(){
      try{ sessionStorage.removeItem(AUTH_STORE); }catch(_){ }
      try{ localStorage.removeItem(AUTH_STORE); }catch(_){ }
      auth = { token:'', role:'', user:'' };
    }

    function showLogin(msg){
      const bd = document.getElementById('loginBackdrop');
      const m = document.getElementById('loginMsg');
      if(m) m.textContent = msg || '‚Äî';
      if(bd){ bd.style.display = 'grid'; bd.classList.add('open'); }
      const u = document.getElementById('loginUser');
      const p = document.getElementById('loginPass');
      setTimeout(()=>{
        try{
          if(u && !u.value) u.focus();
          else if(p) p.focus();
        }catch(_){ }
      }, 50);
    }

    function hideLogin(){
      const bd = document.getElementById('loginBackdrop');
      if(bd){ bd.classList.remove('open'); bd.style.display = 'none'; }
      const m = document.getElementById('loginMsg'); if(m) m.textContent = '‚Äî';
      const p = document.getElementById('loginPass'); if(p) p.value = '';
    }

    async function apiAuthLogin(user, pass, remember){
      const url = API_URL + (API_URL.includes('?')?'&':'?') + 'action=auth_login';
      const body = JSON.stringify({ user, pass });
      const r = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
        body
      });
      const j = await r.json();
      if(!j || !j.ok) throw new Error((j && j.error) ? j.error : 'Falha no login');
      auth = { token: String(j.token), role: String(j.role), user: String(j.user || user) };
      authSave(!!remember);
      return auth;
    }

    function updateUserUI(){
      const pill = document.getElementById('userPill');
      const lab = document.getElementById('userLabel');
      const logout = document.getElementById('btnLogout');
      const loginBtn = document.getElementById('btnLogin');
      if(pill && lab){
        if(canRead()){
          pill.style.display = 'inline-flex';
          lab.textContent = `${auth.user} ‚Ä¢ ${String(auth.role||'').toUpperCase()}`;
        } else {
          pill.style.display = 'none';
          lab.textContent = '‚Äî';
        }
      }
      if(logout){
        logout.style.display = canRead() ? 'inline-flex' : 'none';
      }
      if(loginBtn){
        loginBtn.style.display = canRead() ? 'none' : 'inline-flex';
      }

      // Subt√≠tulos
      const sr = document.getElementById('subtitleReader');
      const se = document.getElementById('subtitleEditor');
      if(sr && se){
        if(canEdit()){
          sr.style.display = 'none';
          se.style.display = 'inline';
          se.textContent = `ONLINE ‚Ä¢ ${String(auth.role||'EDITOR').toUpperCase()} ‚Ä¢ Acesso por login`
        }else{
          se.style.display = 'none';
          sr.style.display = 'inline';
          sr.textContent = `ONLINE ‚Ä¢ LEITOR ‚Ä¢ Acesso por login`;
        }
      }
    }

    async function validateToken(){
      // Se existe token salvo mas expirou no servidor, forca re-login
      if(!auth || !auth.token) return false
      const ctrl = new AbortController();
      const t = setTimeout(()=>ctrl.abort(), 4500);
      try{
        const url = API_URL + (API_URL.includes('?')?'&':'?') + 'action=state_get&token=' + encodeURIComponent(auth.token);
        const r = await fetch(url, { cache:'no-store', signal: ctrl.signal });
        let j = null;
        try{ j = await r.json(); }catch(_){ return false; }
        if(j && j.ok === false) return false;
        // aceita formato {ok:true,state:{...}} ou estado direto
        if(j && j.ok && j.state) return true;
        if(j && Array.isArray(j.items)) return true;
        return false;
      }catch(_){
        return false;
      } finally {
        clearTimeout(t);
      }
    }

    async function ensureAuth(){
      authLoad();
      updateUserUI();
      if(canRead()){
        const ok = await validateToken();
        if(ok) return true;
        authClear();
        updateUserUI();
      }

      return new Promise((resolve)=>{
        showLogin('Fa√ßa login para acessar.');
        const btn = document.getElementById('loginBtn');
        const u = document.getElementById('loginUser');
        const p = document.getElementById('loginPass');
        const rem = document.getElementById('loginRemember');

        const handler = async ()=>{
          try{
            btn.disabled = true;
            const user = (u.value||'').trim();
            const pass = (p.value||'').trim();
            if(!user || !pass) throw new Error('Preencha usu√°rio e senha.');
            await apiAuthLogin(user, pass, rem && rem.checked);
            hideLogin();
            updateUserUI();
            setModeUI();
            resolve(true);
          }catch(e){
            showLogin(String(e && e.message ? e.message : e));
          }finally{
            btn.disabled = false;
          }
        };

        btn.onclick = handler;
        p.onkeydown = (ev)=>{ if(ev.key === 'Enter') handler(); };
        u.onkeydown = (ev)=>{ if(ev.key === 'Enter') handler(); };
      });
    }

    function signatureOf(st){
      // Prefer rev-based signature (very fast)
      if(st && st._rev){
        return 'rev:' + String(st._rev);
      }

      // Fallback: streaming hash (no sort, no giant JSON string)
      let h = 2166136261; // FNV-1a 32-bit
      const add = (v)=>{
        const s = (v==null ? '' : String(v));
        for(let i=0;i<s.length;i++){
          h ^= s.charCodeAt(i);
          h = Math.imul(h, 16777619) >>> 0;
        }
      };

      const items = Array.isArray(st?.items) ? st.items : [];
      const dispatches = Array.isArray(st?.dispatches) ? st.dispatches : [];
      add('i'+items.length);
      add('d'+dispatches.length);

      // Mix a few stable-ish fields; order changes will also change signature (OK for polling)
      for(let i=0;i<items.length;i++){
        const it = items[i] || {};
        add(it.id); add(it.column); add(it.empresa); add(it.quality);
        add(it.updatedAt); add(it.createdAt);
        add((it.notes||'').length);
      }
      for(let i=0;i<dispatches.length;i++){
        const d = dispatches[i] || {};
        add(d.id); add(d.date); add(d.bucket);
        add(d.time); add(d.operator);
        add(d.code||d.num);
        add(d.qty||d.qtd||d.count||0);
      }

      // metas and support config lengths
      const metas = st?.metas || {};
      add('m'+Object.keys(metas).length);
      try{
        for(const k of Object.keys(metas).sort()){
          add(k); add(metas[k]);
        }
      }catch(_){ }

      const resp = (st?.supportConfig && Array.isArray(st.supportConfig.responsaveis)) ? st.supportConfig.responsaveis : [];
      add('r'+resp.length);
      for(const n of resp){ add(n); }

      return String(h);
    }

    async function apiGET(){
      // Timeout para n√£o travar a UI com rede ruim
      const ctrl = new AbortController();
      const t = setTimeout(()=>ctrl.abort(), 12000);
      try{
        const r = await fetch(API_URL + (API_URL.includes('?')?'&':'?') + 'action=state_get&token=' + encodeURIComponent(auth.token) + '&_ts=' + Date.now() + '&_ts=' + Date.now(), { cache:'no-store', signal: ctrl.signal });
        let j = await r.json();
        if(j && j.ok && j.state) j = j.state;
        if(j && j.ok === false) throw new Error(j.error || 'Sem acesso');
        if(!j || !Array.isArray(j.items)) throw new Error('API inv√°lida');
        if(!Array.isArray(j.dispatches)) j.dispatches = [];
        // assinatura r√°pida (usa _rev se existir)
        try{
          const sig = signatureOf(j);
          // cache local (stale-while-revalidate)
          const payload = { ts: Date.now(), state: j, sig };
          const key = cacheKeyOnline();
          if('requestIdleCallback' in window) requestIdleCallback(()=>cacheSet(key, payload).catch(()=>{}), {timeout: 1200});
          else setTimeout(()=>cacheSet(key, payload).catch(()=>{}), 0);
        }catch(_){ }
        return j;
      } finally {
        clearTimeout(t);
      }
    }

    async function apiPOST_bestEffort(payload){
      // Envia como text/plain (evita preflight e costuma ser mais r√°pido no Apps Script)
      const desiredSig = signatureOf(payload);
      const url = API_URL + (API_URL.includes('?') ? '&' : '?') + 'token=' + encodeURIComponent(auth.token);
      const body = JSON.stringify(payload);
      const desiredRev = (payload && payload._rev) ? String(payload._rev) : '';

      async function confirmSaved(){
        // Confirma√ß√£o mais r√°pida (sem esperar 3s sempre)
        const waits = [220, 450, 900, 1500];
        for(const w of waits){
          await new Promise(res=>setTimeout(res, w));
          const remote = await apiGET();
          if(desiredRev && String(remote._rev||'') === desiredRev) return true;
          const sigR = signatureOf(remote);
          if(sigR === desiredSig) return true;
        }
        throw new Error('N√£o confirmou salvamento.');
      }

      const backoff = [0, 650, 1200];
      let lastErr = null;

      for(let attempt=0; attempt<backoff.length; attempt++){
        if(backoff[attempt]) await new Promise(r=>setTimeout(r, backoff[attempt]));

        // 1) no-cors (muito r√°pido) + confirma√ß√£o por GET
        try{
          await fetch(url, { method:"POST", mode:"no-cors", body, keepalive:true });
          await confirmSaved();
          return true;
        }catch(e){
          lastErr = e;
        }

        // 2) tentativa cors text/plain (se o deploy permitir)
        try{
          const ctrl = new AbortController();
          const t = setTimeout(()=>ctrl.abort(), 15000);
          try{
            await fetch(url, {
              method: "POST",
              headers: { "Content-Type": "text/plain;charset=utf-8" },
              body,
              signal: ctrl.signal,
              keepalive: true
            });
          } finally { clearTimeout(t); }
          await confirmSaved();
          return true;
        }catch(e){
          lastErr = e;
        }
      }

      throw (lastErr || new Error('Falha ao salvar'));
    }

    function setModeUI(){
      const dot=$("#modeDot"), text=$("#modeText");
      // Role classes (somente UI)
      document.body.classList.remove('role-leitor','role-editor','role-supervisor');
      if(auth.role === 'supervisor') document.body.classList.add('role-supervisor');
      else if(auth.role === 'editor') document.body.classList.add('role-editor');
      else document.body.classList.add('role-leitor');

      dot.className="dot";
      if(canEdit()){
        dot.classList.add("good");
        text.textContent = (auth.role==="supervisor") ? (syncing ? "Supervisor ‚Ä¢ salvando‚Ä¶" : "Supervisor") : (syncing ? "Editor ‚Ä¢ salvando‚Ä¶" : "Editor");
      }else{
        dot.classList.add("mid");
        text.textContent = "Leitor (online)";
      }
      $("#btnAdd").disabled = !canEdit();
      $("#btnSave").disabled = !canEdit();
      $("#btnAddLine").disabled = !canEdit();
      $("#btnImport").disabled = !canEdit();
      const bd = document.getElementById("btnProgDeleteSelected");
      const bc = document.getElementById("btnProgClearDay");
      if(bd) bd.disabled = true;
      if(bc) bc.disabled = !canEdit();
      // Hide editor-only controls in Leitura
      ["btnAdd","btnSave","btnAddLine","btnImport","btnProgDeleteSelected","btnProgClearDay"].forEach(id=>{
        const el = document.getElementById(id);
        if(el) el.style.display = canEdit() ? "inline-flex" : "none";
      });
      const sr = document.getElementById("subtitleReader");
      const se = document.getElementById("subtitleEditor");
      if(sr && se){ sr.style.display = canEdit() ? "none" : "inline"; se.style.display = canEdit() ? "inline" : "none"; }

      // Hide Programa√ß√£o for leitores
      $("#tabProg").style.display = canEdit() ? "inline-flex" : "none";
      $("#tabSupport").style.display = canEdit() ? "inline-flex" : "none";
      if(!canEdit()){
        $("#viewProg").style.display = "none";
        $("#viewSupport").style.display = "none";
        if($("#tabProg").classList.contains("active") || $("#tabSupport").classList.contains("active")){ setTab("agenda"); }
      }

      // Hide editor-only shortcuts (atalhos) in Leitura
      document.querySelectorAll('.editorOnly').forEach(el=>{
        if(canEdit()) el.style.removeProperty('display');
        else el.style.display = 'none';
      });

    }

    function stripForSave(st){
      // reduz payload (e evita salvar campos transit√≥rios/caches)
      const out = {
        items: Array.isArray(st?.items) ? st.items : [],
        dispatches: Array.isArray(st?.dispatches) ? st.dispatches : [],
        metas: st?.metas || {},
        supportConfig: st?.supportConfig || {}
      };
      if(st && st._rev) out._rev = st._rev;
      return out;
    }

    function scheduleSave(opts){
      // opts: { immediate?: boolean, skipTouch?: boolean }
      if(!canEdit()) return;
      opts = opts || {};

      if(!opts.skipTouch){
        dirty = true;
        changeRev++;
        persistDraftSoon();
      }

      clearTimeout(saveTimer);
      const delay = opts.immediate ? 80 : 650;
      saveTimer = setTimeout(async ()=>{
        // Evita corridas: 1 save por vez
        if(saveInFlight){ pendingSave = true; return; }
        if(!canEdit()) return;

        saveInFlight = true;
        pendingSave = false;

        const revToSave = changeRev;
        const snapshot = safeClone(stripForSave(state));

        // Fast change signature for online sync
        snapshot._rev = Date.now();

        try{
          syncing = true; setModeUI();
          await apiPOST_bestEffort(snapshot);

          savedRev = Math.max(savedRev, revToSave);
          lastSig = signatureOf(snapshot); // remoto deve refletir isso
          try{ state._rev = snapshot._rev; }catch(_){ }
          try{ cacheSetSoon(); }catch(_){ }

          // Se n√£o houve novas edi√ß√µes durante o save, podemos limpar o dirty
          if(savedRev === changeRev){
            dirty = false;
            clearDraft();
            toast("Salvo no online.");
            try{ localStorage.setItem("__bm_rev_broadcast", String(snapshot._rev || Date.now())); }catch(_){ }
          }else{
            // Houve novas mudan√ßas enquanto salvava ‚Üí mant√©m dirty e agenda novo save
            dirty = true;
            scheduleSave({ immediate:true, skipTouch:true });
          }

        }catch(e){
          // N√ÉO sobrescreve state com remoto (evita perda de dados)
          dirty = true;
          toast("Falha ao salvar no online. Seus dados ficaram guardados neste navegador (rascunho). Tente novamente.");
        }finally{
          syncing = false;
          saveInFlight = false;
          setModeUI();

          // Se algu√©m editou durante o save, agenda mais um
          if(pendingSave){
            pendingSave = false;
            scheduleSave({ immediate:true, skipTouch:true });
          }
        }
      }, delay);
    }

    

    // Render coalescing (evita re-render em cascata)
    let __renderRAF = 0;
    function scheduleRenderCurrent(){
      if(__renderRAF) return;
      __renderRAF = requestAnimationFrame(()=>{
        __renderRAF = 0;
        try{ renderCurrentTab(); }catch(_){ }
      });
    }

async function poll(){
      // Evita concorr√™ncia e evita travar quando a aba est√° oculta
      if(document.hidden) return;
      // evita "tique" durante uso
      if(canEdit() && Date.now() - (window.__lastUI || 0) < 1200) return;
      const ae = document.activeElement;
      if(canEdit() && ae && ['INPUT','TEXTAREA','SELECT'].includes(ae.tagName)) return;

      if(syncing || dirty) return;
      if(window.__pollInFlight) return;
      window.__pollInFlight = true;
      try{
        const remote = await apiGET();
        const sig = signatureOf(remote);
        if(!lastSig) lastSig = sig;
        if(sig !== lastSig){
          state = remote;
          lastSig = sig;
          scheduleRenderCurrent();
        }
      }catch(e){}
      finally{ window.__pollInFlight = false; }
    }

    // ---------- BOARD ----------
    function qdot(q){ return q==="APROVADO" ? "good" : q==="BAIXA" ? "bad" : "mid"; }
    function qualityLabel(q){
      if(q==="APROVADO") return "Aprovado";
      if(q==="BAIXA") return "Qualidade baixa";
      return "Qualidade m√©dia";
    }
    function matchesSearch(it){
      const s = ($("#search").value||"").trim().toLowerCase();
      if(!s) return true;
      const hay = [it.bmId, it.notes||"", it.column||"", it.quality||""].join(" ").toLowerCase();
      return hay.includes(s);
    }
    function renderBoard(){
      const board = $("#board");
      if(!board) return;

      // Inicializa colunas uma vez (bem mais r√°pido)
      if(!board.__inited){
        board.__inited = true;
        board.__cols = new Map();
        board.replaceChildren();

        const frag = document.createDocumentFragment();
        for(const col of COLUMNS){
          const colEl = document.createElement('div');
          colEl.className = 'col';
          colEl.innerHTML = `
            <div class="col-header">
              <b>${col.name}</b>
              <span class="badge" data-badge="${col.id}">0</span>
            </div>
            <div class="dropzone" data-col="${col.id}"></div>
          `;
          const badge = colEl.querySelector('[data-badge]');
          const dz = colEl.querySelector('.dropzone');
          board.__cols.set(col.id, { badge, dz });
          frag.appendChild(colEl);
        }
        board.appendChild(frag);

        // Drag&drop por delega√ß√£o (1 listener s√≥)
        if(!board.__dnd){
          board.__dnd = true;
          board.addEventListener('dragover', (e)=>{
            if(!canEdit()) return;
            const dz = e.target.closest('.dropzone');
            if(!dz || !board.contains(dz)) return;
            e.preventDefault();
            dz.classList.add('dragover');
          });
          board.addEventListener('dragleave', (e)=>{
            if(!canEdit()) return;
            const dz = e.target.closest('.dropzone');
            if(!dz || !board.contains(dz)) return;
            dz.classList.remove('dragover');
          });
          board.addEventListener('drop', (e)=>{
            if(!canEdit()) return;
            const dz = e.target.closest('.dropzone');
            if(!dz || !board.contains(dz)) return;
            e.preventDefault();
            dz.classList.remove('dragover');
            let id = '';
            try{ id = e.dataTransfer.getData('text/plain'); }catch(_){ id=''; }
            if(!id) return;
            const colId = dz.getAttribute('data-col');
            const idx = (state.items||[]).findIndex(x=>x.id===id);
            if(idx>=0 && colId){
              state.items[idx].column = colId;
              state.items[idx].updatedAt = nowISO();
              scheduleSave();
              scheduleRenderCurrent();
            }
          });
        }
      }

      let totalVisible = 0;

      for(const col of COLUMNS){
        const slot = board.__cols.get(col.id);
        if(!slot) continue;
        const items = (state.items||[])
          .filter(it=>it.column===col.id)
          .filter(matchesEmpresa)
          .filter(matchesSearch);

        totalVisible += items.length;
        if(slot.badge) slot.badge.textContent = String(items.length);

        const frag = document.createDocumentFragment();
        for(const it of items){
          const card = document.createElement('div');
          card.className = 'card' + (canEdit()? '' : ' readonly');
          card.draggable = !!canEdit();
          card.setAttribute('data-id', it.id);
          const notes = it.notes ? escapeHtml(it.notes).slice(0,140) : 'Sem observa√ß√µes.';
          card.innerHTML = `
            <div class="card-top">
              <div style="min-width:0">
                <div class="bm-id">üè∑Ô∏è ${escapeHtml(it.bmId||"")}</div>
                <div class="meta">
                  <span class="chip"><strong>üìå ${toBR(it.createdAt||"")}</strong></span>
                  <span class="chip"><strong>üè¢ ${empresaLabel(it.empresa||"")}</strong></span>
                  <span class="chip"><span class="qdot ${qdot(it.quality||"MEDIA")}" style="width:8px;height:8px;border-radius:999px;display:inline-block"></span>
                    <strong>${it.quality==="BAIXA" ? "RISCO" : qualityLabel(it.quality||"MEDIA")}</strong></span>
                </div>
                <div class="small" style="margin-top:8px">${notes}</div>
              </div>
              <div class="actions">
                <button class="iconbtn" ${canEdit()? "" : "disabled"} data-edit="${it.id}">‚úèÔ∏è</button>
              </div>
              ${!isSupervisor() ? `<div class="muted" style="margin-top:8px">Obs: apenas <b>supervisores</b> podem definir Respons√°vel/Prioridade.</div>` : ``}
            </div>
          `;
          frag.appendChild(card);
        }
        slot.dz.replaceChildren(frag);
      }

      const bc = document.getElementById('bmCount');
      if(bc) bc.textContent = String(totalVisible);
    }

    // ---------- BM MODAL ----------
    let currentBmId = null;

    function normalizeNumbers(text){
      const arr = String(text||"").split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
      const seen = new Set();
      const out=[];
      for(const n of arr){ if(!seen.has(n)){ seen.add(n); out.push(n); } }
      return out.slice(0,10);
    }

    function openBm(id){
      const isNew = !id;
      currentBmId = id || null;
      const bm = isNew ? null : state.items.find(x=>x.id===id);

      $("#bmTitle").textContent = isNew ? "Nova BM" : "Editar BM";
      $("#fBmId").value = bm?.bmId || "";
      $("#fEmpresa").value = bm?.empresa || "";
      $("#fColumn").value = bm?.column || "standby";
      $("#fQuality").value = bm?.quality || "MEDIA";
      $("#fNumbers").value = (bm?.numbers || []).join("\n");
      $("#fNotes").value = bm?.notes || "";
      $("#fCreatedAt").value = bm ? `${toBR(bm.createdAt)} (${bm.createdAt})` : `${toBR(todayISO())} (${todayISO()})`;
      $("#fUpdatedAt").value = bm?.updatedAt || "‚Äî";
      $("#fDisparoDate").value = bm?.disparoDate || "";
      $("#fDisparoWeekday").value = bm?.disparoWeekday || "";
      $("#fNumbersCount").textContent = `${normalizeNumbers($("#fNumbers").value).length}/10`;
      updateBmDetailsUI();
      const more = document.getElementById("bmMore");
      if(more){
        const hasDetails = (bm && (((bm.numbers||[]).length>0) || (bm.disparoDate||"") || (bm.disparoWeekday||"") || String(bm.notes||"").trim()));
        more.open = !!hasDetails;
      }

      const lock = !canEdit();
      ["fBmId","fEmpresa","fColumn","fQuality","fNumbers","fNotes","fDisparoDate","fDisparoWeekday"].forEach(k=>{
        const el = document.getElementById(k);
        if(el) el.disabled = lock;
      });
      $("#bmSave").disabled = lock;
      $("#bmDelete").disabled = lock || isNew;
      $("#bmMode").textContent = lock ? "Leitura" : "Edi√ß√£o";

      $("#bmBackdrop").classList.add("open");
    }
    
    function updateBmDetailsUI(){
      const col = ($("#fColumn").value || "standby");
      const nw = document.getElementById("bmNumbersWrap");
      const sw = document.getElementById("bmScheduleWrap");
      if(nw) nw.style.display = (col === "numeros") ? "block" : "none";
      if(sw) sw.style.display = (col === "disparos") ? "block" : "none";
    }

function closeBm(){
      $("#bmBackdrop").classList.remove("open");
      currentBmId = null;
    }

        $("#fColumn").addEventListener("change", ()=>{
      updateBmDetailsUI();
      const col = ($("#fColumn").value||"");
      if(col==="numeros" || col==="disparos"){
        const more = document.getElementById("bmMore");
        if(more) more.open = true;
      }
    });

$("#fNumbers").addEventListener("input", ()=>{ $("#fNumbersCount").textContent = `${normalizeNumbers($("#fNumbers").value).length}/10`; });

    $("#bmSave").addEventListener("click", ()=>{
      if(!canEdit()) return;
      const bmId = ($("#fBmId").value||"").trim();
      if(!bmId){ toast("Informe a identifica√ß√£o da BM."); return; }
      const empresa = normalizeEmpresa($("#fEmpresa").value);
      if(!empresa){ toast("Selecione a Empresa / Produto."); return; }

      const patch = {
        bmId,
        empresa,
        column: $("#fColumn").value,
        quality: $("#fQuality").value,
        numbers: normalizeNumbers($("#fNumbers").value),
        notes: ($("#fNotes").value||"").trim(),
        disparoDate: $("#fDisparoDate").value,
        disparoWeekday: $("#fDisparoWeekday").value,
        updatedAt: nowISO()
      };

      if(currentBmId){
        const idx = state.items.findIndex(x=>x.id===currentBmId);
        if(idx>=0){
          state.items[idx] = { ...state.items[idx], ...patch };
        }
      }else{
        state.items.unshift({
          id: uid(),
          createdAt: todayISO(),
          ...patch
        });
      }

      scheduleSave();
      renderAll();
      closeBm();
    });

    $("#bmDelete").addEventListener("click", ()=>{
      if(!canEdit() || !currentBmId) return;
      if(!confirm("Excluir essa BM?")) return;
      state.items = state.items.filter(x=>x.id!==currentBmId);
      scheduleSave();
      renderAll();
      closeBm();
    });

    $("#bmClose").addEventListener("click", closeBm);
    $("#bmCancel").addEventListener("click", closeBm);
    $("#bmBackdrop").addEventListener("click", (e)=>{ if(e.target===$("#bmBackdrop")) closeBm(); });

    // ---------- PROGRAMA√á√ÉO ----------
    function getProgDate(){ return $("#progDate").value || todayISO(); }
    function getProgBucket(){ return $("#progBucket").value || "GBR_CLT"; }
    function listDispatches(date,bucket){
      const dt = String(date||"").slice(0,10);
      const b  = normalizeBucket(bucket);
      const out = [];
      const arr = Array.isArray(state.dispatches) ? state.dispatches : [];
      for(const d of arr){
        const dd = String(d.date||"").slice(0,10);
        const bb = normalizeBucket(d.bucket||"");
        if(dd !== dt) continue;
        if(bb !== b) continue;

        // normalize shape
        const code = (d.code!=null ? String(d.code) : (d.num!=null ? String(d.num) : "")).trim();
        const last4 = (d.last4!=null ? String(d.last4) : code.slice(-4));
        const qty = Number(d.qty ?? d.qtd ?? d.count ?? 0) || 0;
        const time = (d.time!=null ? String(d.time) : "");
        const operator = (d.operator!=null ? String(d.operator) : "");
        out.push({ ...d, code, last4, qty, time, operator, bucket: bb, date: dd });
      }
      return out;
    }
function computeTotals(date,bucket){
      const list = listDispatches(date,bucket);
      const qty = list.reduce((a,x)=>a+(Number(x.qty)||0),0);
      $("#totals").innerHTML = `<strong>${list.length}</strong> linhas ‚Ä¢ <strong>${qty}</strong> disparos`;
    }

    function generateText(date,bucket){
      const list=listDispatches(date,bucket).slice().sort((a,b)=>String(a.operator||"").localeCompare(String(b.operator||"")) || String(a.time||"").localeCompare(String(b.time||"")));
      const ops=[...new Set(list.map(x=>(x.operator||"").trim().toUpperCase()).filter(Boolean))].sort();
      const out=[];
      for(const op of ops){
        out.push(op,"");
        const rows=list.filter(x=>(x.operator||"").trim().toUpperCase()===op).sort((a,b)=>String(a.time||"").localeCompare(String(b.time||"")));
        for(const r of rows){
          if(!r.code) continue;
          out.push(`${r.code} - ${Number(r.qty||0)} (${r.time||"00:00"})`);
        }
        out.push("");
      }
      return out.join("\n").trim()+"\n";
    }

    function renderProg(){
      const date=getProgDate(), bucket=getProgBucket();
      const tbody=$("#progBody");
      tbody.innerHTML="";
      const editable=canEdit();
      const key = String(date||"").slice(0,10) + "|" + normalizeBucket(bucket);
      if(progSelKey !== key){ progSelKey = key; progSel.clear(); }
      const list=listDispatches(date,bucket).slice().sort((a,b)=>String(a.time||"").localeCompare(String(b.time||"")));
      for(const d of list){
        const tr=document.createElement("tr");
        tr.innerHTML = `
          <td>${editable ? `<input type="checkbox" class="progSel" data-sel="${d.id}" ${progSel.has(String(d.id)) ? "checked" : ""} />` : ""}</td>
          <td><input class="cell" ${editable?"":"disabled"} data-id="${d.id}" data-k="operator" value="${escapeHtml(d.operator||"")}"></td>
          <td><input class="cell" ${editable?"":"disabled"} data-id="${d.id}" data-k="code" value="${escapeHtml(d.code||"")}"></td>
          <td><input class="cell" ${editable?"":"disabled"} type="number" min="0" step="1" data-id="${d.id}" data-k="qty" value="${Number(d.qty||0)}"></td>
          <td><input class="cell" ${editable?"":"disabled"} type="time" data-id="${d.id}" data-k="time" value="${escapeHtml(d.time||"")}"></td>
          <td>${editable ? `<button class="btn" data-del="${d.id}">Del</button>` : ""}</td>
        `;
        tbody.appendChild(tr);
      }
      tbody.querySelectorAll("input[data-id]").forEach(inp=>{
        inp.addEventListener("change", ()=>{
          if(!canEdit()) return;
          const id=inp.getAttribute("data-id");
          const k=inp.getAttribute("data-k");
          const row=state.dispatches.find(x=>x.id===id);
          if(!row) return;
          let v=inp.value;
          if(k==="operator") v=String(v||"").trim().toUpperCase();
          if(k==="code") v=String(v||"").trim();
          if(k==="qty") v=Number(v||0);
          if(k==="time") v=String(v||"").trim();
          row[k]=v;
          scheduleSave();
          renderAgendaProg();
          renderProg();
        });
      });
      // Sele√ß√£o em massa
      tbody.querySelectorAll("input.progSel").forEach(cb=>{
        cb.addEventListener("change", ()=>{
          if(!canEdit()) return;
          const id = String(cb.getAttribute("data-sel")||"");
          if(!id) return;
          if(cb.checked) progSel.add(id); else progSel.delete(id);
          updateProgBulkUI(list.map(x=>String(x.id)));
        });
      });
      updateProgBulkUI(list.map(x=>String(x.id)));

      tbody.querySelectorAll("button[data-del]").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          if(!canEdit()) return;
          const id=btn.getAttribute("data-del");
          state.dispatches = state.dispatches.filter(x=>x.id!==id);
          scheduleSave();
          renderAgendaProg();
          renderProg();
        });
      });
      computeTotals(date,bucket);
      $("#progOutput").textContent = generateText(date,bucket);
    }

    function getProgVisibleIds(){
      const date=getProgDate(), bucket=getProgBucket();
      return listDispatches(date,bucket).slice()
        .sort((a,b)=>String(a.time||"").localeCompare(String(b.time||"")))
        .map(x=>String(x.id||""))
        .filter(Boolean);
    }
    function updateProgBulkUI(visibleIds){
      const editable = canEdit();
      const bd = document.getElementById("btnProgDeleteSelected");
      const bc = document.getElementById("btnProgClearDay");
      const sa = document.getElementById("progSelectAll");
      const vis = Array.isArray(visibleIds) ? visibleIds : getProgVisibleIds();
      const selectedCount = vis.reduce((n,id)=> n + (progSel.has(id)?1:0), 0);

      if(bd){
        bd.disabled = !editable || selectedCount===0;
        bd.textContent = selectedCount ? `üóëÔ∏è Apagar selecionados (${selectedCount})` : "üóëÔ∏è Apagar selecionados";
      }
      if(bc){
        bc.disabled = !editable || vis.length===0;
        bc.textContent = vis.length ? `üßπ Limpar dia (${vis.length})` : "üßπ Limpar dia";
      }
      if(sa){
        sa.disabled = !editable || vis.length===0;
        const all = vis.length>0 && selectedCount===vis.length;
        const any = selectedCount>0;
        sa.checked = all;
        sa.indeterminate = any && !all;
      }
    }
    function progDeleteSelected(){
      if(!canEdit()) return;
      const vis = getProgVisibleIds();
      const ids = vis.filter(id=>progSel.has(id));
      if(ids.length===0) return;
      if(!confirm(`Apagar ${ids.length} linha(s) selecionada(s) desta programa√ß√£o?`)) return;

      const rm = new Set(ids);
      state.dispatches = (state.dispatches||[]).filter(d=> !rm.has(String(d.id||"")) );

      ids.forEach(id=>progSel.delete(id));
      scheduleSave();
      renderAgendaProg();
      renderProg();
      toast("Apagado.");
    }
    function progClearDay(){
      if(!canEdit()) return;
      const vis = getProgVisibleIds();
      if(vis.length===0) return;
      const date=getProgDate(), bucket=getProgBucket();
      if(!confirm(`Limpar TODA a programa√ß√£o (${vis.length} linha(s)) de ${bucketLabel(bucket)} em ${fmtDate(date)}?`)) return;

      const rm = new Set(vis);
      state.dispatches = (state.dispatches||[]).filter(d=> !rm.has(String(d.id||"")) );
      progSel.clear();

      scheduleSave();
      renderAgendaProg();
      renderProg();
      toast("Dia limpo.");
    }


    function addLine(){
      if(!canEdit()) return toast("Abra o link de edi√ß√£o.");
      state.dispatches.unshift({ id:uid(), date:getProgDate(), bucket:getProgBucket(), operator:"", code:"", qty:0, time:"" });
      scheduleSave();
      renderProg();
      renderAgendaProg();
    }

    function openImport(){
      if(!canEdit()) return toast("Abra o link de edi√ß√£o.");
      $("#importText").value="";
      $("#importBackdrop").classList.add("open");
    }
    function closeImport(){ $("#importBackdrop").classList.remove("open"); }

    function parseProgramText(text){
      const lines=String(text||"").split(/\r?\n/);
      let currentOp=""; let count=0;
      for(const raw of lines){
        const line=raw.trim();
        if(!line) continue;
        const m=line.match(/^(.+?)\s*-\s*(\d+)\s*\((\d{2}:\d{2})\)\s*$/);
        if(m){
          const code=m[1].trim();
          const qty=Number(m[2]||0);
          const time=m[3].trim();
          if(!currentOp) currentOp="OPERADOR";
          state.dispatches.unshift({ id:uid(), date:getProgDate(), bucket:getProgBucket(), operator:currentOp.toUpperCase(), code, qty, time });
          count++;
        }else{
          currentOp=line.toUpperCase();
        }
      }
      return count;
    }

    $("#importClose").addEventListener("click", closeImport);
    $("#importCancel").addEventListener("click", closeImport);
    $("#importBackdrop").addEventListener("click", (e)=>{ if(e.target===$("#importBackdrop")) closeImport(); });
    $("#importRun").addEventListener("click", ()=>{
      if(!canEdit()) return;
      const count = parseProgramText($("#importText").value||"");
      closeImport();
      scheduleSave();
      renderProg();
      renderAgendaProg();
      toast(`Importado: ${count} linha(s).`);
    });

    // ---------- AGENDA ----------
    function renderAgendaProg(){
      const wrap = $("#agendaProg");
      const focusWrap = document.getElementById("agendaProgFocus");
      const resumoWrap = document.getElementById("agendaProgResumo");
      wrap.innerHTML = "";
      if(focusWrap) focusWrap.innerHTML = "";
      if(resumoWrap) resumoWrap.innerHTML = "";

      const bucketSet = getSelectedBuckets();
      const empresaOf = (bucket)=> String(bucket||"").split("_")[0]; // GBR_CLT -> GBR

      // Agrupa por data respeitando filtros
      const byDate = new Map();
      for(const d of (state.dispatches||[])){
        if(!d.date) continue;
        const date = d.date;
        if(!inDateRange(date)) continue;
        const b = normalizeBucket(d.bucket);
        if(!bucketSet.has(b)) continue;
        if(!byDate.has(date)) byDate.set(date, []);
        byDate.get(date).push({ ...d, bucket: b });
      }
      const dates = [...byDate.keys()].sort();

      // Foco real: hoje e amanh√£ (se existirem)
      const today = todayISO();
      const tomorrow = addDays(today, 1);
      const focusDates = [today, tomorrow].filter(d=>byDate.has(d));

      // Helpers de soma
      const totalsByEmpresa = (arr)=>{
        const m = new Map();
        for(const it of (arr||[])){
          const emp = empresaOf(it.bucket);
          m.set(emp, (m.get(emp)||0) + (Number(it.qty)||0));
        }
        return m;
      };
      const totalsToPills = (m)=>{
        const entries = Array.from(m.entries()).sort((a,b)=>a[0].localeCompare(b[0]));
        if(!entries.length) return `<span class="muted">Sem programa√ß√£o</span>`;
        return entries.map(([emp,val])=>`<span class="pill"><strong>${escapeHtml(emp)}:</strong> ${Number(val||0)}</span>`).join("");
      };
      const totalsToLine = (m)=>{
        const entries = Array.from(m.entries()).sort((a,b)=>a[0].localeCompare(b[0]));
        if(!entries.length) return "Sem programa√ß√£o";
        return entries.map(([emp,val])=>`${emp} ${Number(val||0)}`).join(" ‚Ä¢ ");
      };

      // Render foco (Hoje/Amanh√£) ‚Äî compacto e objetivo
      if(focusWrap){
        const slots = [
          { label:"Hoje", date: today, cls:"rowToday" },
          { label:"Amanh√£", date: tomorrow, cls:"rowTomorrow" }
        ];
        focusWrap.innerHTML = slots.map(s=>{
          const arr = byDate.get(s.date) || [];
          const total = arr.reduce((a,x)=>a+(Number(x.qty)||0),0);
          const empTotals = totalsByEmpresa(arr);
          return `
            <div class="focusCard">
              <div class="d">
                <span><b>${escapeHtml(s.label)}</b> ‚Ä¢ ${escapeHtml(toBR(s.date))}</span>
                <span class="muted">${arr.length ? (arr.length + " linha(s)") : "‚Äî"}</span>
              </div>
              <div class="t">${total ? String(total) : "0"} <span class="muted" style="font-weight:700;font-size:13px">disparos</span></div>
              <div class="meta">${totalsToPills(empTotals)}</div>
            </div>
          `;
        }).join("");
      }

      if(!dates.length){
        if(resumoWrap){
          resumoWrap.innerHTML = `<div class="muted">Nenhuma programa√ß√£o no filtro selecionado.</div>`;
        }
        wrap.innerHTML = `<div class="muted">Nenhuma programa√ß√£o no filtro selecionado.</div>`;
        $("#agendaCount").textContent = "0";
        return;
      }

      // Tabela r√°pida (1 linha por dia) ‚Äî pra bater o olho
      if(resumoWrap){
        const rows = dates.map(date=>{
          const arr = byDate.get(date) || [];
          const total = arr.reduce((a,x)=>a+(Number(x.qty)||0),0);
          const empTotals = totalsByEmpresa(arr);
          const cls = (date===today) ? "rowToday" : (date===tomorrow ? "rowTomorrow" : "");
          return `
            <tr class="${cls}">
              <td style="white-space:nowrap"><b>${escapeHtml(toBR(date))}</b></td>
              <td style="white-space:nowrap"><b>${total}</b></td>
              <td><div class="empLine">${escapeHtml(totalsToLine(empTotals))}</div></td>
            </tr>
          `;
        }).join("");
        resumoWrap.innerHTML = `
          <table class="table">
            <thead>
              <tr>
                <th style="width:140px">Data</th>
                <th style="width:120px">Total</th>
                <th>Por empresa</th>
              </tr>
            </thead>
            <tbody>${rows}</tbody>
          </table>
        `;
      }

      // Detalhamento por dia (abre s√≥ hoje/amanh√£ se existir)
      let itemCount = 0;
      for(const date of dates){
        const arr = byDate.get(date).slice();
        itemCount += arr.length;
        const total = arr.reduce((a,x)=>a+(Number(x.qty)||0),0);

        // Totais por empresa (pra n√£o confundir com produto)
        const empTotals = totalsByEmpresa(arr);

        const det = document.createElement("details");
        det.open = focusDates.includes(date);
        det.innerHTML = `
          <summary>
            <div>
              <div><b>üìÖ ${escapeHtml(toBR(date))}</b></div>
              <div class="muted">${arr.length} linha(s) ‚Ä¢ Total <b>${total}</b></div>
            </div>
            <div class="summary-right">
              ${Array.from(empTotals.entries()).sort((a,b)=>a[0].localeCompare(b[0]))
                .map(([emp,t])=>`<span class="chip"><strong>${escapeHtml(emp)}:</strong> ${Number(t||0)}</span>`).join("")}
            </div>
          </summary>
        `;

        // Mant√©m o detalhamento completo (por bucket) s√≥ dentro do "abre"
        const buckets = Array.from(new Set(arr.map(x=>x.bucket))).sort();
        for(const b of buckets){
          const sub = arr.filter(x=>x.bucket===b).slice().sort((a,b)=>String(a.time||"").localeCompare(String(b.time||"")));
          const subTotal = sub.reduce((a,x)=>a+(Number(x.qty)||0),0);
          const section = document.createElement("div");
          section.style.marginTop = "10px";
          section.innerHTML = `
            <div class="controls" style="justify-content:space-between;align-items:center">
              <div><b>${escapeHtml(bucketLabel(b))}</b></div>
              <span class="chip"><strong>Total</strong> ${subTotal}</span>
            </div>
            <table class="table">
              <thead>
                <tr>
                  <th style="width:110px">Hora</th>
                  <th style="width:140px">4 d√≠gitos</th>
                  <th style="width:110px">Qtd</th>
                  <th>Operador</th>
                </tr>
              </thead>
              <tbody>
                ${sub.map(d=>`
                  <tr>
                    <td>${escapeHtml(d.time||"")}</td>
                    <td>${escapeHtml(d.slot||"")}</td>
                    <td><b>${Number(d.qty||0)}</b></td>
                    <td>${escapeHtml((d.operator||"").toUpperCase())}</td>
                  </tr>
                `).join("")}
              </tbody>
            </table>
          `;
          det.appendChild(section);
        }

        wrap.appendChild(det);
      }

      $("#agendaCount").textContent = String(itemCount);
    }



    // ---------- DASHBOARD ----------
    function dashApplyQuick(){
      const v = document.getElementById("dashQuick")?.value || "7";
      const today = todayISO();
      if(v === "today"){
        document.getElementById("dashFrom").value = today;
        document.getElementById("dashTo").value = today;
      }else if(v === "7"){
        document.getElementById("dashFrom").value = today;
        document.getElementById("dashTo").value = addDays(today, 7);
      }else{
        document.getElementById("dashFrom").value = "";
        document.getElementById("dashTo").value = "";
      }
    }

    function dashInRange(dateIso){
      const from = document.getElementById("dashFrom")?.value || "";
      const to = document.getElementById("dashTo")?.value || "";
      if(from && dateIso < from) return false;
      if(to && dateIso > to) return false;
      return true;
    }

    function renderDashboard(){
      const fromEl = document.getElementById("dashFrom");
      const toEl = document.getElementById("dashTo");
      const qEl = document.getElementById("dashQuick");
      const empEl = document.getElementById("dashEmpresa");
      const prodEl = document.getElementById("dashProduto");
      if(!fromEl || !toEl || !qEl || !empEl) return;

      const produtoSel = (prodEl ? (prodEl.value || "ALL") : "ALL");

      // defaults on first open
      if(!fromEl.value && !toEl.value && (qEl.value || "") === "7"){
        dashApplyQuick();
      }

      const empresaSel = empEl.value || "ALL";

      const byEmp = new Map();
      const byDate = new Map();

      let totalQty = 0;
      let totalLines = 0;

      for(const d of (state.dispatches || [])){
        if(!d.date) continue;
        const date = String(d.date);
        if(!dashInRange(date)) continue;
        const b = normalizeBucket(d.bucket);
        if(empresaSel !== "ALL" && b !== empresaSel) continue;
        if(produtoSel !== "ALL" && bucketProduct(b) !== produtoSel) continue;

        const qty = Number(d.qty||0);
        const time = String(d.time||"").trim();

        totalQty += qty;
        totalLines += 1;

        // by empresa
        if(!byEmp.has(b)) byEmp.set(b, { bucket:b, lines:0, qty:0, dates:new Set(), minTime:"", maxTime:"" });
        const e = byEmp.get(b);
        e.lines += 1;
        e.qty += qty;
        e.dates.add(date);
        if(time){
          if(!e.minTime || time < e.minTime) e.minTime = time;
          if(!e.maxTime || time > e.maxTime) e.maxTime = time;
        }

        // by date
        if(!byDate.has(date)) byDate.set(date, { date, lines:0, qty:0, buckets:new Map() });
        const dd = byDate.get(date);
        dd.lines += 1;
        dd.qty += qty;
        dd.buckets.set(b, (dd.buckets.get(b) || 0) + qty);
      }

      document.getElementById("dashTotalQty").textContent = String(totalQty);
      document.getElementById("dashTotalLines").textContent = String(totalLines);


      // KPIs executivos (leitura r√°pida)
      const execTotalEl = document.getElementById("dashExecTotal");
      const execTotalSub = document.getElementById("dashExecTotalSub");
      const execAvgEl = document.getElementById("dashExecAvg");
      const execAvgSub = document.getElementById("dashExecAvgSub");
      const execLeaderEl = document.getElementById("dashExecLeader");
      const execLeaderSub = document.getElementById("dashExecLeaderSub");
      const execDeltaEl = document.getElementById("dashExecDelta");
      const execDeltaSub = document.getElementById("dashExecDeltaSub");

      if(execTotalEl) execTotalEl.textContent = String(totalQty);
      if(execTotalSub) execTotalSub.textContent = `${totalLines} linha(s) ‚Ä¢ ${byDate.size} dia(s) com dados`;

      const daysWithData = Math.max(0, byDate.size);
      const avg = daysWithData ? (totalQty / daysWithData) : 0;
      if(execAvgEl) execAvgEl.textContent = daysWithData ? avg.toFixed(1) : "‚Äî";
      if(execAvgSub) execAvgSub.textContent = daysWithData ? `Base: ${daysWithData} dia(s)` : "";

      // L√≠der do per√≠odo
      const leaderRow = Array.from(byEmp.values()).sort((a,b)=>Number(b.qty||0)-Number(a.qty||0))[0];
      if(execLeaderEl){
        if(leaderRow){
          const share = totalQty ? ((Number(leaderRow.qty||0)/totalQty)*100).toFixed(1) : "0.0";
          execLeaderEl.textContent = `${bucketLabel(leaderRow.bucket)} (${leaderRow.qty})`;
          if(execLeaderSub) execLeaderSub.textContent = `${share}% do per√≠odo`;
        }else{
          execLeaderEl.textContent = "‚Äî";
          if(execLeaderSub) execLeaderSub.textContent = "";
        }
      }

      // Vs per√≠odo anterior (mesmo tamanho da janela selecionada)
      if(execDeltaEl){
        const fromV = fromEl.value || "";
        const toV = toEl.value || "";
        let prevQty = null;

        const parseISO = (s)=>{
          const [y,m,d] = String(s||"").split("-").map(Number);
          return new Date(y, (m||1)-1, d||1);
        };

        if(fromV && toV){
          const len = Math.max(1, Math.round((parseISO(toV) - parseISO(fromV)) / 86400000) + 1);
          const prevFrom = addDays(fromV, -len);
          const prevTo = addDays(fromV, -1);

          let pq = 0;
          for(const d of (state.dispatches || [])){
            if(!d.date) continue;
            const date = String(d.date);
            if(prevFrom && date < prevFrom) continue;
            if(prevTo && date > prevTo) continue;

            const b = normalizeBucket(d.bucket);
            if(empresaSel !== "ALL" && b !== empresaSel) continue;
            if(produtoSel !== "ALL" && bucketProduct(b) !== produtoSel) continue;

            pq += Number(d.qty||0);
          }
          prevQty = pq;

          if(prevQty > 0){
            const delta = totalQty - prevQty;
            const pct = ((delta / prevQty) * 100).toFixed(1);
            const sign = delta > 0 ? "+" : "";
            execDeltaEl.textContent = `${sign}${delta} (${sign}${pct}%)`;
            if(execDeltaSub) execDeltaSub.textContent = `Anterior: ${prevQty} (${toBR(prevFrom)} ‚Üí ${toBR(prevTo)})`;
          }else{
            execDeltaEl.textContent = prevQty === 0 && totalQty > 0 ? "Novo" : "‚Äî";
            if(execDeltaSub) execDeltaSub.textContent = prevQty === 0 ? `Anterior: 0 (${toBR(prevFrom)} ‚Üí ${toBR(prevTo)})` : "";
          }
        }else{
          execDeltaEl.textContent = "‚Äî";
          if(execDeltaSub) execDeltaSub.textContent = "Defina De/At√© para comparar";
        }
      }
      // Estado vazio (profissional)
      const dashEmpty = document.getElementById("dashEmpty");
      const dashNonEmpty = document.getElementById("dashNonEmpty");
      if(dashEmpty && dashNonEmpty){
        if(totalLines === 0){
          dashEmpty.style.display = "block";
          dashNonEmpty.style.display = "none";
          return;
        }else{
          dashEmpty.style.display = "none";
          dashNonEmpty.style.display = "block";
        }
      }

      // Tend√™ncia (√∫ltimos 7 dias): total di√°rio + Top 2 empresas
      const trendCanvas = document.getElementById('dashTrendCanvas');
      const trendSumEl = document.getElementById('dashTrendSum');
      const trendLeaderEl = document.getElementById('dashTrendLeader');
      const trendHint = document.getElementById('dashTrendHint');

      if(trendCanvas){
        const daysAll = Array.from(byDate.values()).map(r=>r.date).sort((a,b)=>String(a).localeCompare(String(b)));
        const last7 = daysAll.slice(Math.max(0, daysAll.length-7));
        const totalSeries = { name:'Total', values: last7.map(d=>byDate.get(d)?.qty||0) };

        // Top 2 empresas no per√≠odo filtrado
        const totalsByBucket = new Map();
        for(const r of byDate.values()){
          for(const [b,q] of r.buckets.entries()){
            totalsByBucket.set(b, (totalsByBucket.get(b)||0) + Number(q||0));
          }
        }
        const topBuckets = Array.from(totalsByBucket.entries()).sort((a,b)=>b[1]-a[1]).slice(0,2).map(x=>x[0]);
        const bucketSeries = topBuckets.map(b=>({ name: bucketLabel(b), values: last7.map(d=> (byDate.get(d)?.buckets.get(b) || 0)) }));

        const series = [totalSeries, ...bucketSeries];
        drawTrendCanvas(trendCanvas, last7, series);

        const sum7 = totalSeries.values.reduce((a,b)=>a+Number(b||0),0);
        if(trendSumEl) trendSumEl.textContent = String(sum7);

        if(trendLeaderEl){
          if(topBuckets.length){
            const b0 = topBuckets[0];
            const v0 = totalsByBucket.get(b0) || 0;
            trendLeaderEl.textContent = `Top: ${bucketLabel(b0)} (${v0})`;
          }else trendLeaderEl.textContent = '‚Äî';
        }

        if(trendHint){
          if(last7.length){
            const first=last7[0], last=last7[last7.length-1];
            trendHint.textContent = `Janela: ${toBR(first)} ‚Üí ${toBR(last)} ‚Ä¢ Linhas: Total + Top 2 empresas do per√≠odo.`;
          }else trendHint.textContent = 'Sem datas para montar a tend√™ncia.';
        }
      }


      // Envios por empresa
      const empWrap = document.getElementById("dashByEmpresa");
      if(empWrap){
        const rows = Array.from(byEmp.values()).sort((a,b)=>bucketLabel(a.bucket).localeCompare(bucketLabel(b.bucket)));
        if(rows.length === 0){
          empWrap.innerHTML = '<div class="muted">Sem envios no per√≠odo.</div>';
        }else{
          empWrap.innerHTML = `
            <table class="table">
              <thead>
                <tr>
                  <th>Empresa</th>
                  <th style="width:90px">Dias</th>
                  <th style="width:90px">Linhas</th>
                  <th style="width:110px">Disparos</th>
                  <th style="width:120px">% do per√≠odo</th>
                  <th style="width:140px">Janela</th>
                </tr>
              </thead>
              <tbody>
                ${rows.map(r=>{
                  const days = r.dates.size;
                  const win = (r.minTime && r.maxTime) ? (r.minTime + '‚Äì' + r.maxTime) : '‚Äî';
                  return `
                    <tr>
                      <td><b>${escapeHtml(bucketLabel(r.bucket))}</b></td>
                      <td>${days}</td>
                      <td>${r.lines}</td>
                      <td><b>${r.qty}</b></td>
                      <td>${totalQty? ((r.qty/totalQty)*100).toFixed(1) : "0.0"}%</td>
                      <td class="mono">${escapeHtml(win)}</td>
                    </tr>
                  `;
                }).join('')}
              </tbody>
            </table>
          `;
        }
      }

      // Envios por data
      const dateWrap = document.getElementById("dashByDate");
      if(dateWrap){
        const rows = Array.from(byDate.values()).sort((a,b)=>String(a.date).localeCompare(String(b.date)));
        if(rows.length === 0){
          dateWrap.innerHTML = '<div class="muted">Sem datas no per√≠odo.</div>';
        }else{
          dateWrap.innerHTML = `
            <table class="table">
              <thead>
                <tr>
                  <th style="width:120px">Data</th>
                  <th style="width:90px">Linhas</th>
                  <th style="width:110px">Disparos</th>
                  <th>Empresas</th>
                </tr>
              </thead>
              <tbody>
                ${rows.map(r=>{
                  const chips = Array.from(r.buckets.entries())
                    .sort((a,b)=>bucketLabel(a[0]).localeCompare(bucketLabel(b[0])))
                    .map(([b,t])=>`<span class="chip"><strong>${escapeHtml(bucketLabel(b))}:</strong> ${t}</span>`)
                    .join(' ');
                  return `
                    <tr>
                      <td><b>${escapeHtml(toBR(r.date))}</b></td>
                      <td>${r.lines}</td>
                      <td><b>${r.qty}</b></td>
                      <td>${chips}</td>
                    </tr>
                  `;
                }).join('')}
              </tbody>
            </table>
          `;
        }
      }

      // BMs criadas (vis√£o r√°pida)
      const bmsWrap = document.getElementById("dashBms");
      if(bmsWrap){
        const from = document.getElementById("dashFrom")?.value || "";
        const to = document.getElementById("dashTo")?.value || "";
        const map = new Map();
        for(const it of (state.items || [])){
          const created = String(it.createdAt||"");
          if(!created) continue;
          if(from && created < from) continue;
          if(to && created > to) continue;
          const emp = normalizeEmpresa(it.empresa || "");
          const key = emp || "SEM";
          map.set(key, (map.get(key) || 0) + 1);
        }
        const rows = Array.from(map.entries()).sort((a,b)=>String(a[0]).localeCompare(String(b[0])));
        if(rows.length === 0){
          bmsWrap.innerHTML = '<div class="muted">Sem BMs criadas no per√≠odo.</div>';
        }else{
          bmsWrap.innerHTML = `
            <div class="controls" style="justify-content:flex-start;gap:8px;flex-wrap:wrap">
              ${rows.map(([k,v])=>{
                const label = k === "SEM" ? "Sem empresa" : empresaLabel(k);
                return `<span class="chip"><strong>${escapeHtml(label)}:</strong> ${v}</span>`;
              }).join('')}
            </div>
          `;
        }
      }
    

      // Comparativo do dia (gr√°fico simples) + comparativos
      const daySel = document.getElementById('dashDay');
      const barsWrap = document.getElementById('dashDayBars');
      const dayTotalEl = document.getElementById('dashDayTotal');
      const dayLeaderEl = document.getElementById('dashDayLeader');
      const dayGapEl = document.getElementById('dashDayGap');
      const dayHintEl = document.getElementById('dashDayHint');
      const dayVsPrevEl = document.getElementById('dashDayVsPrev');
      const weekVsPrevEl = document.getElementById('dashWeekVsPrev');

      if(daySel && barsWrap){
        daySel.onchange = () => renderDashboard();
        const days = Array.from(byDate.values()).map(r=>r.date).sort((a,b)=>String(a).localeCompare(String(b)));
        const prev = daySel.value || '';
        daySel.innerHTML = days.map(d=>`<option value='${escapeHtml(d)}'>${escapeHtml(toBR(d))}</option>`).join('');
        if(prev && days.includes(prev)) daySel.value = prev;
        else daySel.value = (days[days.length-1] || '');

        const selDay = daySel.value;
        const row = byDate.get(selDay);
        const entries = row ? Array.from(row.buckets.entries()) : [];
        entries.sort((a,b)=>Number(b[1])-Number(a[1]));

        const sum = entries.reduce((acc, it)=>acc + Number(it[1]||0), 0);
        const max = entries.length ? Number(entries[0][1]||0) : 0;

        // KPIs do dia
        if(dayTotalEl) dayTotalEl.textContent = sum ? String(sum) : '‚Äî';
        if(dayLeaderEl) dayLeaderEl.textContent = entries.length ? `${bucketLabel(entries[0][0])} (${entries[0][1]})` : '‚Äî';
        if(dayGapEl){
          if(entries.length >= 2){
            const gap = Number(entries[0][1]) - Number(entries[1][1]);
            const pct = entries[1][1] ? ((gap/Number(entries[1][1]))*100).toFixed(1) : '0.0';
            dayGapEl.textContent = `${gap} (${pct}%)`;
          }else{
            dayGapEl.textContent = '‚Äî';
          }
        }
        // Top 3 do dia (executivo)
        const top3El = document.getElementById("dashTop3");
        if(top3El){
          const top = entries.slice(0,3);
          if(top.length === 0){
            top3El.innerHTML = '<div class="muted">Selecione um dia com dados para ver o Top 3.</div>';
          }else{
            top3El.innerHTML = top.map(([b,qty],i)=>{
              const q = Number(qty||0);
              const share = sum ? ((q/sum)*100).toFixed(1) : '0.0';
              return `<div class="dashTop3Item">
                <div><b>#${i+1}</b> ${escapeHtml(bucketLabel(b))}</div>
                <div><b>${q}</b> <span class="muted">(${share}%)</span></div>
              </div>`;
            }).join("");
          }
        }


        // Vs dia anterior
        if(dayVsPrevEl){
          const idx = days.indexOf(selDay);
          if(idx > 0){
            const prevDay = days[idx-1];
            const prevRow = byDate.get(prevDay);
            const prevSum = prevRow ? prevRow.qty : 0;
            const delta = sum - prevSum;
            const pct = prevSum ? ((delta/prevSum)*100).toFixed(1) : '0.0';
            const sign = delta>0 ? '+' : '';
            dayVsPrevEl.textContent = `${sign}${delta} (${sign}${pct}%)`;
          }else{
            dayVsPrevEl.textContent = '‚Äî';
          }
        }

        // Semana (5d) vs semana anterior (base no dia selecionado)
        if(weekVsPrevEl){
          const idx = days.indexOf(selDay);
          if(idx >= 0){
            const curStart = Math.max(0, idx-4);
            const curDays = days.slice(curStart, idx+1);
            const prevDays = days.slice(Math.max(0, curStart-5), curStart);
            const sumCur = curDays.reduce((a,d)=>a+(byDate.get(d)?.qty||0),0);
            const sumPrev = prevDays.reduce((a,d)=>a+(byDate.get(d)?.qty||0),0);
            const delta = sumCur - sumPrev;
            const pct = sumPrev ? ((delta/sumPrev)*100).toFixed(1) : '0.0';
            const sign = delta>0 ? '+' : '';
            weekVsPrevEl.textContent = prevDays.length ? `${sign}${delta} (${sign}${pct}%)` : '‚Äî';
          }else weekVsPrevEl.textContent = '‚Äî';
        }

        // Bars + drilldown
        if(entries.length === 0){
          barsWrap.innerHTML = '<div class="muted">Sem dados no dia selecionado.</div>';
          if(dayHintEl) dayHintEl.textContent = '';
        }else{
          barsWrap.innerHTML = entries.map(([b,qty])=>{
            const q = Number(qty||0);
            const w = max ? Math.max(3, Math.round((q/max)*100)) : 0;
            const share = sum ? ((q/sum)*100).toFixed(1) : '0.0';
            return `
              <div class='barrow' data-dd-bucket='${escapeHtml(b)}'>
                <div class='barlabel'>${escapeHtml(bucketLabel(b))}</div>
                <div class='bartrack'><div class='barfill' style='width:${w}%'></div></div>
                <div class='barmeta'><b>${q}</b> <span class='muted'>(${share}%)</span></div>
              </div>
            `;
          }).join('');

          barsWrap.querySelectorAll('[data-dd-bucket]').forEach(el=>{
            el.addEventListener('click', ()=>{
              const b = el.getAttribute('data-dd-bucket');
              if(b) openDashDetail(selDay, b);
            });
          });

          if(dayHintEl){
            const top = entries[0];
            const topShare = sum ? ((Number(top[1])/sum)*100).toFixed(1) : '0.0';
            dayHintEl.textContent = `Dia ${toBR(selDay)} ‚Ä¢ Clique em uma empresa para ver hor√°rios, n√∫meros e quantidades. ‚Ä¢ L√≠der: ${bucketLabel(top[0])} com ${top[1]} (${topShare}%).`;
          }
        }
      }



      // Copiar resumo do dia (somente por empresa)
      const copyBtn = document.getElementById("dashCopyDay");
      if(copyBtn){
        copyBtn.onclick = async () => {
          const daySelEl = document.getElementById("dashDay");
          const selDay = (daySelEl && daySelEl.value) ? String(daySelEl.value).slice(0,10) : "";
          if(!selDay) return toast("Selecione um dia no Dashboard");
          const row = byDate.get(selDay);
          if(!row) return toast("Sem dados para o dia selecionado");

          const lines = Array.from(row.buckets.entries())
            .sort((a,b)=>Number(b[1])-Number(a[1]))
            .map(([b,q]) => `${bucketLabel(b)}: ${Number(q||0)}`);

          const text = `Resumo ${toBR(selDay)}\n` + lines.join("\n");
          await copyToClipboard(text);
        };
      }

    }

    function renderAgendaBms(){
      const wrap=$("#agendaBms");
      const items=(state.items||[]).filter(i=>i.disparoDate || i.disparoWeekday);
      if(!items.length){
        wrap.innerHTML = `<div class="muted">Sem agendamentos de BM.</div>`;
        return;
      }
      const groups=new Map();
      for(const it of items){
        const key = it.disparoDate ? ("D:"+it.disparoDate) : ("W:"+it.disparoWeekday);
        if(!groups.has(key)) groups.set(key, []);
        groups.get(key).push(it);
      }
      const keys=[...groups.keys()].sort();
      wrap.innerHTML = "";
      for(const k of keys){
        const arr=groups.get(k);
        const label = k.startsWith("D:") ? ("üìÖ "+toBR(k.slice(2))) : ("üóìÔ∏è "+k.slice(2));
        const div=document.createElement("div");
        div.className="row";
        div.innerHTML = `<div class="row-left"><div><b>${label}</b></div><div class="small">${arr.length} BM(s)</div></div>
                         <div class="row-right"><span class="kbd">BMs</span></div>`;
        wrap.appendChild(div);
      }
    }

    // ---------- Tabs ----------
    let currentTab = "agenda";
    function setTab(which){
      currentTab = which;
      const isDash=which==="dash", isBoard=which==="board", isAgenda=which==="agenda", isRod=which==="rodizio", isProg=which==="prog", isSupport=which==="support";
      $("#tabDash").classList.toggle("active", isDash);
      $("#tabBoard").classList.toggle("active", isBoard);
      $("#tabAgenda").classList.toggle("active", isAgenda);
      $("#tabRodizio").classList.toggle("active", isRod);
      $("#tabProg").classList.toggle("active", isProg);
      $("#tabSupport").classList.toggle("active", isSupport);

      $("#viewDash").style.display = isDash ? "block" : "none";
      $("#viewBoard").style.display = isBoard ? "block" : "none";
      $("#viewAgenda").style.display = isAgenda ? "block" : "none";
      $("#viewRodizio").style.display = isRod ? "block" : "none";
      $("#viewProg").style.display = isProg ? "block" : "none";
      $("#viewSupport").style.display = isSupport ? "block" : "none";

      // Render sob demanda (melhora muito a velocidade inicial)
      if(isAgenda){
        renderAgendaProg();
        renderAgendaBms();
      }
      if(isBoard){
        // evita travar o clique
        if('requestIdleCallback' in window) requestIdleCallback(()=>renderBoard(), {timeout: 800});
        else setTimeout(renderBoard, 0);
      }
      if(isProg){
        if('requestIdleCallback' in window) requestIdleCallback(()=>renderProg(), {timeout: 800});
        else setTimeout(renderProg, 0);
      }
      if(isSupport) renderSupportTab();
      if(isRod) renderRodizio();
      if(isDash) renderDashboard();

      setModeUI();
    }


    $("#tabDash").addEventListener("click", ()=>setTab("dash"));
    $("#tabBoard").addEventListener("click", ()=>setTab("board"));
    $("#tabAgenda").addEventListener("click", ()=>setTab("agenda"));
    $("#tabRodizio").addEventListener("click", ()=>setTab("rodizio"));

    // Rod√≠zio listeners
    const _rodSend = document.getElementById('rodSend');
    if(_rodSend) _rodSend.addEventListener('click', sendRodizio);
    const _rodRefresh = document.getElementById('rodRefresh');
    if(_rodRefresh) _rodRefresh.addEventListener('click', renderRodizio);
    const _rodEmp = document.getElementById('rodFilterEmpresa');
    if(_rodEmp) _rodEmp.addEventListener('change', renderRodizio);
    const _rodDate = document.getElementById('rodFilterDate');
    if(_rodDate) _rodDate.addEventListener('change', renderRodizio);
    const _rodClear = document.getElementById('rodClearFilters');
    if(_rodClear) _rodClear.addEventListener('click', ()=>{ if(_rodEmp) _rodEmp.value='ALL'; if(_rodDate) _rodDate.value=''; renderRodizio(); });
    // Dashboard listeners
    const _dashApply = document.getElementById('dashApply');
    if(_dashApply) _dashApply.addEventListener('click', renderDashboard);
    const _dashQuick = document.getElementById('dashQuick');
    if(_dashQuick) _dashQuick.addEventListener('change', ()=>{ dashApplyQuick(); renderDashboard(); });
    const _dashEmp = document.getElementById('dashEmpresa');
    if(_dashEmp) _dashEmp.addEventListener('change', renderDashboard);
    const _dashProd = document.getElementById('dashProduto');
    if(_dashProd) _dashProd.addEventListener('change', renderDashboard);
    const _dashMetaSave = document.getElementById('dashMetaSave');
    if(_dashMetaSave) _dashMetaSave.addEventListener('click', ()=>{
      if(!canEdit()) return toast("Leitura. Abra o link de edi√ß√£o.");
      scheduleSave();
      toast("Salvando metas...");
    });
    const _dClose = document.getElementById('dashDetailClose');
    const _dBack = document.getElementById('dashDetailBackdrop');
    if(_dClose && _dBack) _dClose.addEventListener('click', ()=> _dBack.style.display='none');
    if(_dBack) _dBack.addEventListener('click', (e)=>{ if(e.target===_dBack) _dBack.style.display='none'; });


    $("#tabProg").addEventListener("click", ()=>setTab("prog"));
      $("#tabSupport").addEventListener("click", ()=>setTab("support"));
      const sRef = document.getElementById("supportRefresh");
      if(sRef) sRef.addEventListener("click", renderSupportTab);
      const sEmp = document.getElementById("supportEmpresa");
      if(sEmp) sEmp.addEventListener("change", renderSupportTab);
      const sSt = document.getElementById("supportStatus");
      if(sSt) sSt.addEventListener("change", renderSupportTab);
    const sResp = document.getElementById("supportResp");
    if(sResp) sResp.addEventListener("change", renderSupportTab);
    const sCfg = document.getElementById("supportConfigBtn");
    if(sCfg) sCfg.addEventListener("click", ()=>{
      if(!isSupervisor()){ toast("Somente supervisores."); return; }
      const cur = getSupportResponsaveis().join(", ");
      const val = prompt("Respons√°veis (v√≠rgula):", cur);
      if(val === null) return;
      const list = String(val).split(",").map(s=>s.trim()).filter(Boolean);
      setSupportResponsaveis(list);
      toast("Lista de respons√°veis atualizada.");
      renderSupportTab();
    });

    $("#btnAdd").addEventListener("click", ()=>openBm(null));
    $("#btnRefresh").addEventListener("click", async ()=>{
      if(dirty){ toast("Voc√™ tem altera√ß√µes pendentes. Salve antes de recarregar."); return; }
      try{
        const remote = await apiGET();
        state = remote;
        lastSig = signatureOf(state);
        renderAll();
        toast("Recarregado do online.");
      }catch(e){
        toast("Falha ao recarregar do online.");
      }
    });
    $("#btnSave").addEventListener("click", async ()=>{
      if(!canEdit()) return toast("Leitura. Abra o link de edi√ß√£o.");
      scheduleSave({ immediate:true, skipTouch:true });
      toast("Salvando‚Ä¶");
    });

    $("#search").addEventListener("input", debounce(renderBoard, 140));
      const empFilter = document.getElementById("bmEmpresaFilter");
      if(empFilter) empFilter.addEventListener("change", renderBoard);

    // Board: event delegation (mais r√°pido que 1 listener por card)
    const _boardEl = document.getElementById('board');
    if(_boardEl && !_boardEl.__delegated){
      _boardEl.__delegated = true;
      _boardEl.addEventListener('click', (e)=>{
        const btn = e.target.closest('[data-edit]');
        if(btn){
          const id = btn.getAttribute('data-edit');
          if(id) openBm(id);
        }
      });
      _boardEl.addEventListener('dragstart', (e)=>{
        if(!canEdit()) return;
        const card = e.target.closest('.card');
        if(!card) return;
        const id = card.getAttribute('data-id');
        if(!id) return;
        try{
          e.dataTransfer.setData('text/plain', id);
          e.dataTransfer.effectAllowed = 'move';
        }catch(_){ }
      });
    }

    $("#progDate").addEventListener("change", renderProg);
    $("#progBucket").addEventListener("change", renderProg);
    const sa = document.getElementById("progSelectAll");
    if(sa){
      sa.addEventListener("change", ()=>{
        if(!canEdit()) return;
        const vis = getProgVisibleIds();
        if(sa.checked){ vis.forEach(id=>progSel.add(id)); }
        else { vis.forEach(id=>progSel.delete(id)); }
        renderProg();
      });
    }
    const bd = document.getElementById("btnProgDeleteSelected");
    if(bd) bd.addEventListener("click", progDeleteSelected);
    const bc = document.getElementById("btnProgClearDay");
    if(bc) bc.addEventListener("click", progClearDay);
    $("#btnAddLine").addEventListener("click", addLine);
    $("#btnImport").addEventListener("click", openImport);
    $("#btnGenerate").addEventListener("click", ()=>{ $("#progOutput").textContent = generateText(getProgDate(), getProgBucket()); toast("Texto gerado."); });
    $("#btnCopy").addEventListener("click", async ()=>{
      const text=$("#progOutput").textContent||"";
      if(!text.trim()) return toast("Nada para copiar.");
      try{ await navigator.clipboard.writeText(text); toast("Copiado."); }
      catch(e){ toast("N√£o consegui copiar automaticamente."); }
    });

    function renderAll(){
      // Mantido para bot√µes de recarregar; usa render atual + agenda
      renderCurrentTab();
      if(currentTab === 'agenda'){ renderAgendaProg(); renderAgendaBms(); }
      setModeUI();
    }

    function renderCurrentTab(){
      // Atualiza somente o que est√° na tela (menos travamento)
      setModeUI();
      if(currentTab === 'board') return renderBoard();
      if(currentTab === 'dash') return renderDashboard();
      if(currentTab === 'agenda') { renderAgendaProg(); renderAgendaBms(); try{ updateHeroSummary(); }catch(_){ } return; }
      if(currentTab === 'rodizio') return renderRodizio();
      if(currentTab === 'prog') return renderProg();
      if(currentTab === 'support') return renderSupportTab();
      // fallback
      renderBoard();
    }


    async function init(){
      await ensureAuth();
      updateUserUI();

      // Atalhos da tela inicial
      document.addEventListener('click', (e)=>{
        const b = e.target && e.target.closest ? e.target.closest('[data-goto-tab]') : null;
        if(!b) return;
        const tab = b.getAttribute('data-goto-tab');
        if(tab) setTab(tab);
      });

      try{ wirePerfAndLock(); }catch(_){ }
      $("#progDate").value = todayISO();

      // Agenda filter defaults
      if($("#fQuick")){
        $("#fQuick").value = "7";
        $("#fFrom").value = todayISO();
        $("#fTo").value = addDays(todayISO(), 7);
        try{ updateAgendaDayFocus(); }catch(_){ }
        $("#fQuick").addEventListener("change", applyQuickRange);
        $("#btnApply").addEventListener("click", ()=>{ renderAgendaProg(); renderAgendaBms(); });
        // Foco r√°pido: HOJE / AMANH√É (UI)
        const _fmtBR = (iso)=> iso ? iso.split("-").reverse().join("/") : "‚Äî";
        window.updateAgendaDayFocus = function(){
          const today = todayISO();
          const tomorrow = addDays(today, 1);
          const from = $("#fFrom")?.value || "";
          const to = $("#fTo")?.value || "";
          if($("#lblAgendaHoje")) $("#lblAgendaHoje").textContent = _fmtBR(today);
          if($("#lblAgendaAmanha")) $("#lblAgendaAmanha").textContent = _fmtBR(tomorrow);
          const bH = $("#btnAgendaHoje"), bA = $("#btnAgendaAmanha");
          if(bH) bH.classList.toggle("active", from===today && to===today);
          if(bA) bA.classList.toggle("active", from===tomorrow && to===tomorrow);
        };
        const bHoje = $("#btnAgendaHoje"), bAmanha = $("#btnAgendaAmanha");
        if(bHoje) bHoje.addEventListener("click", ()=>{
          $("#fQuick").value = "today";
          applyQuickRange();
          window.scrollTo({top:0, behavior:"smooth"});
        });
        if(bAmanha) bAmanha.addEventListener("click", ()=>{
          $("#fQuick").value = "tomorrow";
          applyQuickRange();
          window.scrollTo({top:0, behavior:"smooth"});
        });
        // Atalhos de teclado (H = hoje, A = amanh√£) somente quando a Agenda estiver vis√≠vel
        document.addEventListener("keydown", (e)=>{
          if(e.altKey||e.ctrlKey||e.metaKey) return;
          const vA = $("#viewAgenda");
          if(!vA || vA.style.display==="none") return;
          const k = (e.key||"").toLowerCase();
          if(k==="h"){ e.preventDefault(); bHoje?.click(); }
          if(k==="a"){ e.preventDefault(); bAmanha?.click(); }
        });

        document.querySelectorAll("input.bucket").forEach(cb=>cb.addEventListener("change", ()=>{ renderAgendaProg(); renderAgendaBms(); }));
      }

      // 1) Render instant√¢neo via rascunho local (se existir)
      setModeUI();
      let renderedOnce = false
      
      try{
        const d = readDraft();
        if(d && d.state){
          state = d.state;
          dirty = true;
          changeRev++;
          lastSig = signatureOf(state);
          setTab("agenda");
          toast("Rascunho local carregado. Sincronizando‚Ä¶");
          renderedOnce = true;
        }
      }catch(_){ }

      // 2) Se n√£o houver rascunho, tenta cache online (IndexedDB) para abrir instant√¢neo
      if(!renderedOnce){
        try{
          // deixa a UI pintar antes
          await new Promise(r=>requestAnimationFrame(r));
          const cached = await cacheGet(cacheKeyOnline());
          if(cached && cached.state){
            state = cached.state;
            lastSig = cached.sig || signatureOf(state);
            setTab("agenda");
            toast("Carregado do cache local. Atualizando do online‚Ä¶");
            renderedOnce = true;
          }
        }catch(_){ }
      }

      // 3) Agora busca o online em background (stale-while-revalidate)
      const loadRemote = async ()=>{
        try{
          const remote = await apiGET();
          const sigR = signatureOf(remote);
          // Se h√° edi√ß√£o pendente, n√£o sobrescreve
          if(!dirty){
            if(!lastSig || sigR !== lastSig){
              state = remote;
              lastSig = sigR;
              // atualiza s√≥ a aba atual (mais r√°pido)
              renderCurrentTab();
            }
          }
          // grava cache
          const payload = { ts: Date.now(), state: remote, sig: sigR };
          const key = cacheKeyOnline();
          if('requestIdleCallback' in window) requestIdleCallback(()=>cacheSet(key, payload).catch(()=>{}), {timeout: 1200});
          else setTimeout(()=>cacheSet(key, payload).catch(()=>{}), 0);

          if(!renderedOnce){
            // se nada renderizou ainda (sem cache e sem draft)
            state = remote;
            lastSig = sigR;
            setTab("agenda");
            renderedOnce = true;
          }

          // Polling (leitores e editores)
          setInterval(poll, 15000);
        document.addEventListener('visibilitychange', ()=>{ if(!document.hidden) poll(); });
        window.addEventListener('storage', (e)=>{ if(e && e.key==='__bm_rev_broadcast') poll(); });
          supportPoll();
          setInterval(supportPoll, 15000);
        }catch(e){
          if(!renderedOnce){
            toast("Falha ao carregar do online. Verifique o Deploy do Apps Script.");
            // √∫ltimo fallback: rascunho local
            const d = readDraft();
            if(d && d.state){
              state = d.state;
              dirty = true;
              toast("Carreguei um rascunho local deste navegador. Clique em Salvar quando a rede voltar.");
            }
            setTab("agenda");
            renderedOnce = true;
          }else{
            toast("Online inst√°vel. Mantive o cache/local.");
          }
          // ainda assim inicia polling (vai tentar mais tarde)
          setInterval(poll, 15000);
          supportPoll();
          setInterval(supportPoll, 15000);
        }
      };

      loadRemote();
    }


    // ---------- EMPRESA (BMs) ----------
    function normalizeEmpresa(raw){
      const e = String(raw||"").trim().toUpperCase();
      if(e === "GBR") return "GBR_NOVO";
      if(e === "GBR NOVO") return "GBR_NOVO";
      if(e === "3P") return "3P_CLT";
      if(e === "3P CLT") return "3P_CLT";
      if(e === "3P PORT") return "3P_PORT";
      if(e === "3P_PORT") return "3P_PORT";
      if(e === "3P_PORT") return "3P PORT";
      if(e === "GBR_CLT") return "GBR_CLT";
      if(e === "GBR_NOVO") return "GBR_NOVO";
      if(e === "3P_CLT") return "3P_CLT";
      if(e === "M2" || e === "M2 PORT" || e === "M2_PORT") return "M2_PORT";
      if(e === "2A" || e === "2A PORT" || e === "2A_PORT") return "2A_PORT";
      if(e === "VMC" || e === "VMC PORT" || e === "VMC_PORT") return "VMC_PORT";
      if(e === "M2_PORT") return "M2_PORT";
      if(e === "2A_PORT") return "2A_PORT";
      if(e === "VMC_PORT") return "VMC_PORT";
      return "";
    }
    function empresaLabel(id){
      const e = normalizeEmpresa(id);
      if(e === "GBR_CLT") return "GBR CLT";
      if(e === "GBR_NOVO") return "GBR NOVO";
      if(e === "3P_CLT") return "3P CLT";
      if(e === "3P_PORT") return "3P PORT";
      if(e === "M2_PORT") return "M2 PORT";
      if(e === "2A_PORT") return "2A PORT";
      if(e === "VMC_PORT") return "VMC PORT";
      return e || "‚Äî";
    }
    function matchesEmpresa(it){
      const sel = (document.getElementById("bmEmpresaFilter")?.value || "ALL");
      const emp = normalizeEmpresa(it.empresa || "");
      if(sel === "ALL") return true;
      if(sel === "SEM") return !emp;
      return emp === sel;
    }


    // ---------- SUPORTE ----------
    (function(){
      const fab = document.getElementById("supportFab");
      const back = document.getElementById("supportBackdrop");
      if(!fab || !back) return;

      const open = ()=> back.classList.add("open");
      const close = ()=> back.classList.remove("open");

      document.getElementById("supportClose")?.addEventListener("click", close);
      document.getElementById("supportOk")?.addEventListener("click", close);
      fab.addEventListener("click", open);

      document.getElementById("supClear")?.addEventListener("click", ()=>{
        document.getElementById("supMsg").value = "";
        document.getElementById("supOps").value = "";
        document.getElementById("supResult").textContent = "‚Äî";
      });

      document.getElementById("supSend")?.addEventListener("click", async ()=>{
        const sender = (document.getElementById("supSender").value||"").trim();
        const empresa = normalizeEmpresa(document.getElementById("supEmpresa").value||"");
        const tipo = (document.getElementById("supTipo").value||"PEDIDO").trim();
        const msg = (document.getElementById("supMsg").value||"").trim();
        const ops = (document.getElementById("supOps").value||"").trim();
        const resEl = document.getElementById("supResult");
        if(!sender){ toast("Informe seu nome/cargo."); return; }
        if(!msg){ toast("Escreva a mensagem."); return; }

        resEl.textContent = "Enviando‚Ä¶";
        const url = API_URL + (API_URL.includes("?")?"&":"?") + "action=inbox_add&token=" + encodeURIComponent(auth.token);
        const payload = { sender, empresa, tipo, msg, ops, createdAt: nowISO() };

        // Tenta POST com confirma√ß√£o (sem preflight)
        const tryConfirmed = async ()=>{
          const r = await fetch(url, { method:"POST", headers:{"Content-Type":"text/plain;charset=utf-8"}, body: JSON.stringify(payload) });
          let data = null;
          try{ data = await r.json(); }catch(_){ data = null; }
          return data;
        };

        try{
          let data = null;
          try{ data = await tryConfirmed(); }catch(_){ data = null; }

          if(data && data.ok){
            resEl.textContent = "‚úÖ Enviado. Um editor vai ver na aba Suportes.";
            toast("Enviado.");
            document.getElementById("supMsg").value = "";
            document.getElementById("supOps").value = "";
            return;
          }
          if(data && data.ok === false){
            const err = data.error || "Falha ao enviar.";
            resEl.textContent = "‚ùå " + err;
            toast("Falha ao enviar.");
            return;
          }

          // Fallback: envia sem confirma√ß√£o
          await fetch(url, { method:"POST", mode:"no-cors", body: JSON.stringify(payload) });
          resEl.textContent = "‚úÖ Enviado (sem confirma√ß√£o).";
          toast("Enviado.");
          document.getElementById("supMsg").value = "";
          document.getElementById("supOps").value = "";
        }catch(e){
          resEl.textContent = "‚ùå Falha ao enviar.";
          toast("Falha ao enviar.");
        }
      });
    })();

    // ---------- SUPORTE (ABA - editores) ----------
    async function supportFetchInbox(){
      const url = API_URL + (API_URL.includes("?") ? "&" : "?") + "action=inbox_list&token=" + encodeURIComponent(auth.token);
      const r = await fetch(url, { cache:"no-store" });
      return await r.json();
    }

    function formatDT(iso){
      if(!iso) return "‚Äî";
      let s = String(iso).trim();
      // suporta "YYYY-MM-DD HH:MM" (sem T)
      if(/^[0-9]{4}-[0-9]{2}-[0-9]{2}\s+[0-9]{2}:[0-9]{2}/.test(s) && !s.includes("T")){
        s = s.replace(" ", "T");
      }
      const d = new Date(s);
      if(isNaN(d.getTime())) return String(iso);
      return d.toLocaleString("pt-BR", { day:"2-digit", month:"2-digit", year:"numeric", hour:"2-digit", minute:"2-digit" });
    }

    function updateSupportBadge(openCount){
      const b = document.getElementById("supportBadge");
      if(!b) return;
      if(openCount > 0){
        b.style.display = "inline-flex";
        b.textContent = String(openCount);
      }else{
        b.style.display = "none";
        b.textContent = "0";
      }
    }

    let supportLatestAt = "";

    function markSupportSeen(){
      if(!canEdit()) return;
      if(supportLatestAt){
        localStorage.setItem("support_last_seen_at", supportLatestAt);
        document.getElementById("tabSupport")?.classList.remove("attn");
      }
    }

    async function supportPoll(){
      if(!canEdit()) return;
      try{
        const data = await supportFetchInbox();
        if(!data || data.ok === false) return;
        const inbox = Array.isArray(data.inbox) ? data.inbox : [];
        populateSupportRespOptions(inbox);
        const open = inbox.filter(it=> String(it.status||"OPEN").toUpperCase() !== "DONE" && String(it.tipo||"").toUpperCase() !== "RODIZIO");
        updateSupportBadge(open.length);

        // normalmente vem ordenado desc por createdAt
        supportLatestAt = (open[0] && open[0].createdAt) ? String(open[0].createdAt) : ((inbox[0] && inbox[0].createdAt) ? String(inbox[0].createdAt) : "");

        const lastSeen = localStorage.getItem("support_last_seen_at") || "";
        if(supportLatestAt){
          const newer = !lastSeen || (new Date(supportLatestAt).getTime() > new Date(lastSeen).getTime());
          if(newer && currentTab !== "support"){
            toast("Novo suporte recebido.");
            document.getElementById("tabSupport")?.classList.add("attn");
          }
          if(currentTab === "support"){
            // se j√° est√° na aba, considera visto
            markSupportSeen();
          }
        }
      }catch(_){ }
    }

    

    
    function getSupportResponsaveis(){
      const cfg = (state && state.supportConfig) ? state.supportConfig : (state.supportConfig = {});
      const list = Array.isArray(cfg.responsaveis) ? cfg.responsaveis : [];
      if(list.length) return list;
      return ["Danilo","Pedro","Mauricio"];
    }
    function setSupportResponsaveis(list){
      state.supportConfig = state.supportConfig || {};
      state.supportConfig.responsaveis = (list||[]).map(s=>String(s).trim()).filter(Boolean);
      scheduleSave();
    }

function populateSupportRespOptions(inbox){
      const sel = document.getElementById("supportResp");
      if(!sel) return;
      const keep = sel.value || "ALL";
      const base = ["ALL","UNASSIGNED"];

      const uniq = new Set();
      // add configured names
      getSupportResponsaveis().forEach(n=>uniq.add(String(n).trim()));
      (inbox||[]).forEach(it=>{
        const a = String(it.assignee||it.responsavel||"").trim();
        if(a) uniq.add(a);
      });

      // rebuild options (keep first two fixed)
      sel.innerHTML = "";
      const o1 = document.createElement("option"); o1.value="ALL"; o1.textContent="Todos respons√°veis"; sel.appendChild(o1);
      const o2 = document.createElement("option"); o2.value="UNASSIGNED"; o2.textContent="Sem respons√°vel"; sel.appendChild(o2);

      Array.from(uniq).sort((a,b)=>a.localeCompare(b,'pt-BR')).forEach(name=>{
        const o = document.createElement("option");
        o.value = name; o.textContent = name;
        sel.appendChild(o);
      });

      // restore selection
      const values = Array.from(sel.options).map(o=>o.value);
      sel.value = values.includes(keep) ? keep : "ALL";
    }
async function supportDeleteItem(payload){
      const url = API_URL + (API_URL.includes("?") ? "&" : "?") + "action=inbox_delete&token=" + encodeURIComponent(auth.token);
      const res = await fetch(url, {
        method: "POST",
        headers: { "Content-Type":"text/plain;charset=utf-8" },
        body: JSON.stringify(payload || {})
      });
      try{ return await res.json(); } catch(_){ return { ok:false, error:"Resposta inv√°lida do servidor."}; }
    }

async function supportUpdateItem(payload){
      const url = API_URL + (API_URL.includes("?") ? "&" : "?") + "action=inbox_update&token=" + encodeURIComponent(auth.token);
      payload.updatedAt = nowISO();
      try{
        const r = await fetch(url, { method:"POST", headers:{"Content-Type":"text/plain;charset=utf-8"}, body: JSON.stringify(payload) });
        try{ return await r.json(); }catch(_){ return null; }
      }catch(e){
        try{ await fetch(url, { method:"POST", mode:"no-cors", body: JSON.stringify(payload) }); }catch(_){ }
        return null;
      }
    }

    async function renderSupportTab(){
      if(!canEdit()) return;
      const listEl = document.getElementById("supportList");
      const countEl = document.getElementById("supportCount");
      const dbgEl = document.getElementById("supportDebug");
      if(!listEl) return;

      listEl.innerHTML = `<div class="muted">Carregando‚Ä¶</div>`;
      if(dbgEl) dbgEl.textContent = "Carregando‚Ä¶";

      try{
        const data = await supportFetchInbox();
        if(!data || data.ok === false){
          const err = (data && data.error) ? data.error : "Inbox n√£o dispon√≠vel.";
          listEl.innerHTML = `<div class="muted">‚ùå ${escapeHtml(err)}</div>`;
          if(countEl) countEl.textContent = "0";
          if(dbgEl) dbgEl.textContent = "Erro";
          return;
        }

        const inbox = Array.isArray(data.inbox) ? data.inbox : [];
        populateSupportRespOptions(inbox);
        const openCount = inbox.filter(it=> String(it.status||"OPEN").toUpperCase() !== "DONE" && String(it.tipo||"").toUpperCase() !== "RODIZIO").length;
        updateSupportBadge(openCount);

        // latest
        supportLatestAt = (inbox[0] && inbox[0].createdAt) ? String(inbox[0].createdAt) : supportLatestAt;
        if(dbgEl) dbgEl.textContent = `Atualizado: ${formatDT(nowISO())} ‚Ä¢ ${inbox.length} total ‚Ä¢ ${isSupervisor()?"Supervisor":"Editor"}`;
        const cfgBtn = document.getElementById("supportConfigBtn");
        if(cfgBtn) cfgBtn.style.display = isSupervisor() ? "inline-flex" : "none";

        const empSel = (document.getElementById("supportEmpresa")?.value || "ALL");
        const stSel = (document.getElementById("supportStatus")?.value || "OPEN");
        const respSel = (document.getElementById("supportResp")?.value || "ALL");

        const filtered = inbox.filter(it=>{
          const emp = normalizeEmpresa(it.empresa||"");
          const tipo = String(it.tipo||"").toUpperCase();
          if(tipo === "RODIZIO") return false;
          const st = String(it.status||"OPEN").toUpperCase();
          const asg = String(it.assignee||it.responsavel||"").trim();
          if(empSel !== "ALL" && emp !== empSel) return false;
          if(stSel !== "ALL" && st !== stSel) return false;
          if(respSel === "UNASSIGNED" && !!asg) return false;
          if(respSel !== "ALL" && respSel !== "UNASSIGNED" && asg !== respSel) return false;
          return true;
        });

        if(countEl) countEl.textContent = String(filtered.length);

        if(filtered.length === 0){
          listEl.innerHTML = `<div class="muted">Sem solicita√ß√µes no filtro.</div>`;
          return;
        }

        // Cards (simples e organizados)
        listEl.innerHTML = filtered.map(it=>{
          const id = String(it.id||"");
          const st = String(it.status||"OPEN").toUpperCase();
          const stLabel = (st === "DONE") ? "Resolvido" : "Aberto";
          const ops = String(it.ops||"").trim();

          const priority = String(it.priority||it.prioridade||"MEDIA").toUpperCase();
          const assignee = String(it.assignee||it.responsavel||"");

          const toggleLabel = (st === "DONE") ? "Reabrir" : "Marcar resolvido";
          const toggleClass = (st === "DONE") ? "btn" : "btn primary";

          return `
            <div class="inbox-item" data-support-card="${escapeHtml(id)}">
              <div class="inbox-top">
                <div>
                  <b>${escapeHtml(it.sender||"")}</b>
                  <div class="muted">${escapeHtml(formatDT(it.createdAt||""))}</div>
                </div>
                <span class="tag"><strong>${escapeHtml(stLabel)}</strong></span>
              </div>

              <div class="inbox-meta">
                <span class="tag"><strong>üè¢</strong> ${escapeHtml(empresaLabel(it.empresa||""))}</span>
                <span class="tag"><strong>üßæ</strong> ${escapeHtml(it.tipo||"")}</span>
              </div>

              <div class="support-msg">${escapeHtml(it.msg||"")}</div>

              ${ops ? `
                <details class="support-ops">
                  <summary>Lista de operadores</summary>
                  <div class="support-msg" style="margin-top:8px">${escapeHtml(ops)}</div>
                </details>
              ` : ``}

              <div class="support-grid" style="margin-top:8px">
                <div class="pill" style="padding:8px 10px" title="Prioridade">
                  <span>‚öë</span>
                  <select data-support-priority="${escapeHtml(id)}" style="border:0;outline:0;background:transparent;color:var(--text)" ${isSupervisor()?"":"disabled"}>
                    <option value="ALTA" ${priority==="ALTA"?"selected":""}>Alta</option>
                    <option value="MEDIA" ${(priority==="MEDIA"||priority==="M√âDIA")?"selected":""}>M√©dia</option>
                    <option value="BAIXA" ${priority==="BAIXA"?"selected":""}>Baixa</option>
                  </select>
                </div>

                <input class="cell" style="max-width:260px" data-support-assignee="${escapeHtml(id)}" placeholder="Respons√°vel" value="${escapeHtml(assignee)}" ${isSupervisor()?"":"disabled"} />

                <button class="btn" data-support-save="${escapeHtml(id)}" ${isSupervisor()?"":"disabled"}>Salvar</button>
                <button class="${toggleClass}" data-support-toggle="${escapeHtml(id)}" data-support-next="${st === "DONE" ? "OPEN" : "DONE"}">${toggleLabel}</button>
                ${isSupervisor() ? `<button class="btn danger" data-support-del="${escapeHtml(id)}">Apagar</button>` : ``}
              </div>
              ${!isSupervisor() ? `<div class="muted" style="margin-top:8px">Obs: apenas <b>supervisores</b> podem definir Respons√°vel/Prioridade.</div>` : ``}
            </div>
          `;
        }).join("");

        // Bind actions
        listEl.querySelectorAll('[data-support-save]').forEach(btn=>{
          btn.addEventListener('click', async ()=>{
            if(!isSupervisor()) { toast('Somente supervisores podem orientar respons√°vel/prioridade.'); return; }
            const id = btn.getAttribute('data-support-save');
            const pr = document.querySelector(`[data-support-priority="${CSS.escape(id)}"]`)?.value || "MEDIA";
            const asg = document.querySelector(`[data-support-assignee="${CSS.escape(id)}"]`)?.value || "";
            const resp = await supportUpdateItem({ id, priority: pr, assignee: asg });
            if(resp && resp.ok === false){ toast(resp.error || "Falha ao salvar."); }
            else toast("Salvo.");
            renderSupportTab();
          });
        });

        listEl.querySelectorAll('[data-support-toggle]').forEach(btn=>{
          btn.addEventListener('click', async ()=>{
const id = btn.getAttribute('data-support-toggle');
            const next = btn.getAttribute('data-support-next') || "DONE";
            const pr = document.querySelector(`[data-support-priority="${CSS.escape(id)}"]`)?.value || "MEDIA";
            const asg = document.querySelector(`[data-support-assignee="${CSS.escape(id)}"]`)?.value || "";
            const payload = { id, status: next };
            if(isSupervisor()) { payload.priority = pr; payload.assignee = asg; }
            const resp = await supportUpdateItem(payload);
            if(resp && resp.ok === false){ toast(resp.error || "Falha ao atualizar."); }
            else toast("Atualizado.");
            renderSupportTab();
          });
        });

        listEl.querySelectorAll('[data-support-del]').forEach(btn=>{
          btn.addEventListener('click', async ()=>{
            if(!isSupervisor()){ toast('Somente supervisores podem apagar.'); return; }
            const id = btn.getAttribute('data-support-del');
            if(!id) return;
            if(!confirm('Apagar este chamado? (a√ß√£o irrevers√≠vel)')) return;
            const resp = await supportDeleteItem({ id });
            if(resp && resp.ok === false){ toast(resp.error || 'Falha ao apagar.'); }
            else toast('Apagado.');
            renderSupportTab();
          });
        });

      }catch(e){
        listEl.innerHTML = `<div class="muted">‚ùå Inbox n√£o carregou: ${escapeHtml(String(e))}</div>`;
        if(countEl) countEl.textContent = "0";
        if(dbgEl) dbgEl.textContent = "Erro";
      }
    }



    // ---------- RODIZIO DO DIA ----------
    function normLines(t){
      return String(t||"").replace(/\r\n/g,'\n').replace(/\r/g,'\n').split('\n').map(s=>s.trim()).filter(Boolean);
    }

    async function sendRodizio(){
      const date = document.getElementById('rodDate')?.value || todayISO();
      const sup = String(document.getElementById('rodSupervisor')?.value||'').trim();
      const emp = String(document.getElementById('rodEmpresa')?.value||'').trim();
      const ops = document.getElementById('rodOperadores')?.value || '';
      const obs = String(document.getElementById('rodObs')?.value||'').trim();

      if(!sup){ toast('Informe o Supervisor.'); return; }
      if(!emp){ toast('Selecione a empresa.'); return; }
      const lines = normLines(ops);
      if(lines.length === 0){ toast('Informe pelo menos 1 operador.'); return; }

      const now = new Date();
      const createdAt = `${date} ${pad2(now.getHours())}:${pad2(now.getMinutes())}`;

      const payload = {
        tipo: 'RODIZIO',
        sender: sup,
        empresa: emp,
        msg: obs || 'Rod√≠zio do dia',
        ops: lines.join('\n'),
        createdAt
      };

      const url = API_URL + (API_URL.includes('?')?'&':'?') + 'action=inbox_add&token=' + encodeURIComponent(auth.token);

      const tryConfirmed = async ()=>{
        const r = await fetch(url, {
          method:'POST',
          headers:{'Content-Type':'text/plain;charset=utf-8'},
          body: JSON.stringify(payload)
        });
        let data = null;
        try{ data = await r.json(); }catch(_){ data = null; }
        return data;
      };

      try{
        let data = null;
        try{ data = await tryConfirmed(); }catch(_){ data = null; }

        if(data && data.ok){
          toast('Rod√≠zio enviado.');
          const ta = document.getElementById('rodOperadores');
          const ob = document.getElementById('rodObs');
          if(ta) ta.value = '';
          if(ob) ob.value = '';
          return;
        }

        if(data && data.ok === false){
          toast(data.error || 'Falha ao enviar.');
          return;
        }

        // fallback: envia sem confirma√ß√£o
        await fetch(url, { method:'POST', mode:'no-cors', body: JSON.stringify(payload) });
        toast('Rod√≠zio enviado.');
        const ta = document.getElementById('rodOperadores');
        const ob = document.getElementById('rodObs');
        if(ta) ta.value = '';
        if(ob) ob.value = '';
      }catch(e){
        toast('Falha ao enviar.');
      }
    }

    async function renderRodizio(){
      const rb = document.getElementById('rodReaderBox');
      const eb = document.getElementById('rodEditorBox');
      const refreshBtn = document.getElementById('rodRefresh');
      const listEl = document.getElementById('rodList');
      const countEl = document.getElementById('rodCount');
      const dbgEl = document.getElementById('rodDebug');

      if(rb) rb.style.display = canEdit() ? 'none' : 'block';
      if(eb) eb.style.display = canEdit() ? 'block' : 'none';
      if(refreshBtn) refreshBtn.style.display = canEdit() ? 'inline-flex' : 'none';

      if(!canEdit()){
        const d = document.getElementById('rodDate');
        if(d && !d.value) d.value = todayISO();
        return;
      }

      if(listEl) listEl.innerHTML = '<div class="muted">Carregando‚Ä¶</div>';
      if(dbgEl) dbgEl.textContent = 'Carregando‚Ä¶';

      try{
        const data = await supportFetchInbox();
        if(!data || data.ok === false){
          const err = (data && data.error) ? data.error : 'Inbox n√£o dispon√≠vel.';
          if(listEl) listEl.innerHTML = `<div class="muted">‚ùå ${escapeHtml(err)}</div>`;
          if(countEl) countEl.textContent = '0';
          if(dbgEl) dbgEl.textContent = 'Erro';
          return;
        }

        const inbox = Array.isArray(data.inbox) ? data.inbox : [];
        const all = inbox.filter(it=> String(it.tipo||'').toUpperCase()==='RODIZIO');

        const empSel = document.getElementById('rodFilterEmpresa')?.value || 'ALL';
        const dateSel = document.getElementById('rodFilterDate')?.value || '';

        const filtered = all.filter(it=>{
          const emp = normalizeBucket(it.empresa||'');
          const d = String(it.createdAt||'').slice(0,10);
          if(empSel !== 'ALL' && emp !== empSel) return false;
          if(dateSel && d !== dateSel) return false;
          return true;
        });

        if(countEl) countEl.textContent = String(filtered.length);
        if(dbgEl) dbgEl.textContent = `Atualizado: ${formatDT(nowISO())} ‚Ä¢ ${filtered.length} no filtro`;

        if(!listEl) return;
        if(filtered.length === 0){
          listEl.innerHTML = '<div class="muted">Sem rod√≠zios no filtro.</div>';
          return;
        }

        listEl.innerHTML = filtered.map(it=>{
          const id = String(it.id||'');
          const when = String(it.createdAt||'');
          const emp = bucketLabel(normalizeBucket(it.empresa||''));
          const sender = String(it.sender||'');
          const msg = String(it.msg||'');
          const ops = String(it.ops||'');
          const canDel = isSupervisor();
          return `
            <div class="inbox-item">
              <div class="inbox-top">
                <div>
                  <b>${escapeHtml(sender || '‚Äî')}</b>
                  <div class="muted">${escapeHtml(formatDT(when))}</div>
                </div>
                <span class="tag"><strong>${escapeHtml(emp)}</strong></span>
              </div>
              <div class="support-msg">${escapeHtml(msg)}</div>
              ${ops ? `
                <details class="support-ops">
                  <summary>Operadores (${normLines(ops).length})</summary>
                  <div class="support-msg" style="margin-top:8px">${escapeHtml(ops)}</div>
                </details>
              ` : ``}
              ${canDel ? `<div class="support-grid" style="margin-top:8px"><button class="btn danger" data-rod-del="${escapeHtml(id)}">Apagar</button></div>` : ``}
            </div>
          `;
        }).join('');

        // bind delete
        if(isSupervisor()){
          listEl.querySelectorAll('[data-rod-del]').forEach(btn=>{
            btn.addEventListener('click', async ()=>{
              const id = btn.getAttribute('data-rod-del');
              if(!id) return;
              if(!confirm('Apagar este rod√≠zio?')) return;
              const resp = await supportDeleteItem({ id });
              if(resp && resp.ok === false) toast(resp.error || 'Falha ao apagar.');
              else toast('Apagado.');
              renderRodizio();
            });
          });
        }

      }catch(e){
        if(listEl) listEl.innerHTML = `<div class="muted">‚ùå Erro: ${escapeHtml(String(e))}</div>`;
        if(countEl) countEl.textContent = '0';
        if(dbgEl) dbgEl.textContent = 'Erro';
      }
    }

    // ---- Performance + Prote√ß√£o (UI) ----
    function applyPerfMode(on){
      try{ localStorage.setItem('exec:perf', on ? '1' : '0'); }catch(_){ }
      document.body.classList.toggle('perf', !!on);
    }

    function loadPerfMode(){
      let on = true;
      try{
        const v = localStorage.getItem('exec:perf');
        if(v === '0') on = false;
      }catch(_){ }
      applyPerfMode(on);
    }

    function wirePerfAndLock(){
      const perfBtn = document.getElementById('btnPerf');
      const lockBtn = document.getElementById('btnLock');
      const logoutBtn = document.getElementById('btnLogout');
      const loginBtn = document.getElementById('btnLogin');
      loadPerfMode();

      if(perfBtn){
        perfBtn.addEventListener('click', ()=>{
          const on = !document.body.classList.contains('perf');
          applyPerfMode(on);
          toast(on ? 'Modo performance: ON ‚ö°' : 'Modo performance: OFF');
        });
      }

      // Bot√£o antigo de lock (n√£o usado com login)
      if(lockBtn){
        lockBtn.style.display = 'none';
      }

      if(loginBtn){
        loginBtn.addEventListener('click', ()=>{
          authClear();
          showLogin('Fa√ßa login para acessar.');
        });
      }

      if(logoutBtn){
        logoutBtn.addEventListener('click', ()=>{
          if(!confirm('Sair deste usu√°rio?')) return;
          // limpa sess√£o e recarrega
          authClear();
          try{ sessionStorage.removeItem('exec:key'); sessionStorage.removeItem('exec:supkey'); sessionStorage.removeItem('exec:editor'); }catch(_){ }
          location.reload();
        });
      }
    }

    init();
  </script>


  <!-- DASHBOARD DETAIL MODAL -->
  <div class="backdrop" id="dashDetailBackdrop" style="display:none">
    <div class="modal" style="max-width:760px">
      <div style="display:flex;align-items:flex-start;justify-content:space-between;gap:12px;flex-wrap:wrap">
        <div>
          <h3 style="margin:0" id="dashDetailTitle">Detalhes</h3>
          <div class="muted" style="margin-top:6px" id="dashDetailSub">‚Äî</div>
        </div>
        <div class="controls" style="justify-content:flex-end">
          <button class="btn" id="dashDetailClose">Fechar</button>
        </div>
      </div>
      <div class="hr" style="margin-top:12px"></div>
      <div class="kpiRow" style="margin-top:12px">
        <div class="kpiBox"><div class="t">Total</div><div class="v" id="dashDetailTotal">‚Äî</div></div>
        <div class="kpiBox"><div class="t">N√∫meros</div><div class="v" id="dashDetailNums">‚Äî</div></div>
        <div class="kpiBox"><div class="t">Janela</div><div class="v" id="dashDetailWin">‚Äî</div></div>
      </div>
      <div class="dashDetailScroll" style="margin-top:12px">
        <table class="table" id="dashDetailTable">
          <thead>
            <tr>
              <th style="width:120px">Hor√°rio</th>
              <th style="width:140px">N√∫mero</th>
              <th style="width:120px">Qtd</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="controls" style="justify-content:flex-end">
        <button class="btn" id="dashDetailToggle" style="display:none">Ver mais</button>
      </div>
      <div class="muted" style="margin-top:10px" id="dashDetailHint"></div>
    </div>
  </div>

</body>
</html>
